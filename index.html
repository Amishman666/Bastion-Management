<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Bastion - Ultimate TTRPG Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0a0e1a;
            --secondary-bg: #1a1f2e;
            --accent-bg: #2a3441;
            --gold: #ffd700;
            --gold-dark: #b8860b;
            --cyan: #00d4ff;
            --red: #ff3366;
            --green: #00ff88;
            --purple: #b266ff;
            --text-primary: #ffffff;
            --text-secondary: #b8c5d1;
            --border: rgba(255, 215, 0, 0.3);
            --glow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        body {
            font-family: 'Exo 2', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, #0f1419 50%, var(--primary-bg) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(178, 102, 255, 0.1) 0%, transparent 50%);
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--glow), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-title {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--gold), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .login-btn {
            background: linear-gradient(45deg, var(--gold), var(--gold-dark));
            color: #000;
            border: none;
            padding: 14px 28px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }

        .role-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .role-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .role-btn.active {
            background: var(--gold);
            color: #000;
            font-weight: 600;
        }

        /* Main App Container */
        .app-container {
            display: none;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-container.show {
            display: block;
        }

        /* Top Navigation */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 30px;
            box-shadow: var(--glow);
        }

        .nav-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--gold), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-gm {
            background: var(--red);
            color: white;
        }

        .role-player {
            background: var(--cyan);
            color: #000;
        }

        .logout-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            border-color: var(--red);
            color: var(--red);
        }

        /* Game Master Dashboard */
        .gm-dashboard {
            display: none;
        }

        .gm-dashboard.show {
            display: block;
        }

        .gm-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .gm-panel {
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--glow);
        }

        .gm-panel h3 {
            color: var(--gold);
            margin-bottom: 15px;
            font-family: 'Orbitron', monospace;
        }

        .resource-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .resource-control input {
            width: 80px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: white;
            text-align: center;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 16px;
            background: var(--green);
            color: #000;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4);
        }

        .quick-btn.danger {
            background: var(--red);
            color: white;
        }

        /* Mission Creator */
        .mission-creator {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .mission-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .mission-form input, .mission-form textarea, .mission-form select {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
        }

        .mission-form textarea {
            grid-column: 1 / -1;
            resize: vertical;
            min-height: 80px;
        }

        /* Player Dashboard */
        .player-dashboard {
            display: none;
        }

        .player-dashboard.show {
            display: block;
        }

        .player-status {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* Mission Board */
        .mission-board {
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--glow);
        }

        .mission-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .mission-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .mission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .mission-title {
            font-weight: 600;
            color: var(--gold);
        }

        .mission-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-available {
            background: var(--green);
            color: #000;
        }

        .status-completed {
            background: var(--gold);
            color: #000;
        }

        .status-locked {
            background: var(--red);
            color: white;
        }

        .mission-rewards {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .reward-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Activity Log */
        .activity-log {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            width: 60px;
        }

        .activity-icon {
            width: 30px;
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .top-nav {
                flex-direction: column;
                gap: 15px;
            }

            .gm-controls {
                grid-template-columns: 1fr;
            }

            .mission-form {
                grid-template-columns: 1fr;
            }

            .player-status {
                grid-template-columns: 1fr;
            }
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--green);
            color: #000;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transform: translateX(300px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--red);
            color: white;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: var(--gold);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Enhanced Sections Grid */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .section-card {
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--glow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .section-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255, 215, 0, 0.2), var(--glow);
        }

        .upgrade-request-btn {
            background: var(--purple);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upgrade-request-btn:hover {
            background: #9c4dff;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="background-animation"></div>
    
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <h1 class="login-title"><i class="fas fa-fortress"></i> THE BASTION</h1>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">Celestial Fortress Management System</p>
            
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" placeholder="Enter your username" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Access Code</label>
                    <input type="password" class="form-input" id="accessCode" placeholder="Campaign access code" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <div class="role-selector">
                        <button type="button" class="role-btn active" data-role="player">
                            <i class="fas fa-user"></i> Player
                        </button>
                        <button type="button" class="role-btn" data-role="gm">
                            <i class="fas fa-crown"></i> Game Master
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Enter The Bastion
                </button>
            </form>
            
            <div style="margin-top: 20px; font-size: 0.9rem; color: var(--text-secondary);">
                <p><strong>Campaign Credentials:</strong></p>
                <p>Player: username "jon" / code "bastion2024"</p>
                <p>GM: username "gm" / code "gmbastion2024"</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="mainApp">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="nav-title">
                <i class="fas fa-fortress"></i> THE BASTION
            </div>
            <div class="nav-controls">
                <div class="user-info">
                    <span id="currentUser">Player Name</span>
                    <span class="role-badge" id="userRole">Player</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Game Master Dashboard -->
        <div class="gm-dashboard" id="gmDashboard">
            <div class="gm-controls">
                <!-- Resource Management -->
                <div class="gm-panel">
                    <h3><i class="fas fa-coins"></i> Resource Management</h3>
                    <div class="resource-control">
                        <span>‚ö° Celestial Power</span>
                        <input type="number" id="gm-celestial-power" value="1250" onchange="updateGlobalResource('celestial-power', this.value)">
                        <span style="font-size: 0.8rem; color: var(--text-secondary);" id="power-capacity">/ 2000</span>
                    </div>
                    <div class="resource-control">
                        <span>ü•à Celestial Silver</span>
                        <input type="number" id="gm-celestial-silver" value="85" onchange="updateGlobalResource('celestial-silver', this.value)">
                    </div>
                    <div class="resource-control">
                        <span>üíé Runic Shards</span>
                        <input type="number" id="gm-runic-shards" value="12" onchange="updateGlobalResource('runic-shards', this.value)">
                    </div>
                    <div class="resource-control">
                        <span>‚ú® Divine Essence</span>
                        <input type="number" id="gm-divine-essence" value="3" onchange="updateGlobalResource('divine-essence', this.value)">
                    </div>
                    <div class="resource-control">
                        <span>üî¨ Tech Expertise</span>
                        <span id="calculated-tech-expertise" style="color: var(--cyan);">Calculated from NPCs</span>
                    </div>
                    
                    <div class="quick-actions" style="margin-top: 15px;">
                        <button class="quick-btn" onclick="addDailyResources()">Daily Generation</button>
                        <button class="quick-btn danger" onclick="resetResources()">Reset Resources</button>
                    </div>
                </div>

                <!-- NPC Management -->
                <div class="gm-panel">
                    <h3><i class="fas fa-users"></i> NPC Management</h3>
                    <div id="npcList" style="max-height: 200px; overflow-y: auto;">
                        <!-- NPCs will be populated here -->
                    </div>
                    
                    <div class="quick-actions" style="margin-top: 15px;">
                        <button class="quick-btn" onclick="createNPC()">Create NPC</button>
                        <button class="quick-btn" onclick="quickCreateNPC()">Quick Random</button>
                        <button class="quick-btn danger" onclick="removeSelectedNPC()">Remove NPC</button>
                        <button class="quick-btn" onclick="manageItems()">Manage Items</button>
                    </div>
                    
                    <div style="margin-top: 10px; padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; font-size: 0.8rem;">
                        <strong>Quick Stats:</strong> Active: <span id="activeNPCCount">2</span> | 
                        Total Tech: <span id="totalTechFromNPCs">7</span> | 
                        Average Loyalty: <span id="avgLoyalty">88%</span>
                    </div>
                </div>

                <!-- Section Management -->
                <div class="gm-panel">
                    <h3><i class="fas fa-wrench"></i> Section Management</h3>
                    <div id="sectionManagement">
                        <!-- Section states will be populated here -->
                    </div>
                    
                    <div class="quick-actions" style="margin-top: 15px;">
                        <button class="quick-btn" onclick="repairAllSections()">Emergency Repair All</button>
                        <button class="quick-btn danger" onclick="damageRandomSection()">Random Damage Event</button>
                    </div>
                </div>

                <!-- Enhanced Mission Management -->
                <div class="gm-panel">
                    <h3><i class="fas fa-scroll"></i> Enhanced Mission Management</h3>
                    <div class="mission-creator" style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                        <div class="mission-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="text" id="mission-title" placeholder="Mission Title" style="padding: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); border-radius: 6px; color: white;">
                            <select id="mission-type" style="padding: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); border-radius: 6px; color: white;">
                                <option>Stealth</option>
                                <option>Combat</option>
                                <option>Tech</option>
                                <option>Social</option>
                                <option>Research</option>
                                <option>Mixed</option>
                            </select>
                            <textarea id="mission-description" placeholder="Mission description..." style="grid-column: 1 / -1; padding: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); border-radius: 6px; color: white; resize: vertical; min-height: 60px;"></textarea>
                            <input type="text" id="mission-requirements" placeholder="Requirements (e.g., Stealth:5,Tech:3)" style="padding: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); border-radius: 6px; color: white;">
                            <input type="text" id="mission-rewards" placeholder="Rewards (e.g., 100 CS, 2 DE)" style="padding: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); border-radius: 6px; color: white;">
                        </div>
                        <button class="quick-btn" style="margin-top: 10px;" onclick="createEnhancedMission()">Create Mission</button>
                    </div>
                    
                    <div id="activeMissionsList" style="max-height: 150px; overflow-y: auto; margin-bottom: 15px;">
                        <!-- Active missions will be populated here -->
                    </div>
                    
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="resolveMissions()">Resolve Missions</button>
                        <button class="quick-btn danger" onclick="clearCompletedMissions()">Clear Completed</button>
                    </div>
                </div>

                <!-- System Controls -->
                <div class="gm-panel">
                    <h3><i class="fas fa-cogs"></i> System Controls</h3>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="saveGameState()">Save Game State</button>
                        <button class="quick-btn" onclick="loadGameState()">Load Backup</button>
                        <button class="quick-btn danger" onclick="resetCampaign()">Reset Campaign</button>
                        <button class="quick-btn" onclick="exportData()">Export Data</button>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                        <strong>Campaign Stats:</strong><br>
                        <span id="campaignStats">NPCs: 2 | Active Missions: 2 | Power Efficiency: 87%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Dashboard -->
        <div class="player-dashboard" id="playerDashboard">
            <div class="player-status">
                <!-- Player Resources -->
                <div class="gm-panel">
                    <h3><i class="fas fa-coins"></i> My Resources</h3>
                    <div id="playerResources">
                        <div class="resource-control">
                            <span>‚ö° Celestial Power</span>
                            <span id="player-celestial-power">1250</span>
                        </div>
                        <div class="resource-control">
                            <span>ü•à Celestial Silver</span>
                            <span id="player-celestial-silver">85</span>
                        </div>
                        <div class="resource-control">
                            <span>üíé Runic Shards</span>
                            <span id="player-runic-shards">12</span>
                        </div>
                        <div class="resource-control">
                            <span>‚ú® Divine Essence</span>
                            <span id="player-divine-essence">3</span>
                        </div>
                        <div class="resource-control">
                            <span>üî¨ Tech Expertise</span>
                            <span id="player-technical-expertise">5</span>
                        </div>
                    </div>
                </div>

                <!-- Available Actions -->
                <div class="gm-panel">
                    <h3><i class="fas fa-tasks"></i> Available Actions</h3>
                    
                    <!-- Section Cleaning -->
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: var(--gold); margin-bottom: 10px;">Section Cleaning</h4>
                        <div id="playerCleaningOptions">
                            <!-- Cleaning options will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Mission Assignment -->
                    <div>
                        <h4 style="color: var(--gold); margin-bottom: 10px;">Mission Assignment</h4>
                        <div id="playerMissionOptions">
                            <!-- Mission options will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Operations -->
            <div class="gm-panel">
                <h3><i class="fas fa-clock"></i> Active Operations</h3>
                <div id="activeOperations" style="max-height: 200px; overflow-y: auto;">
                    <!-- Active cleaning/mission operations will be shown here -->
                </div>
            </div>

            <!-- Mission Board -->
            <div class="mission-board">
                <h3><i class="fas fa-clipboard-list"></i> Mission Board</h3>
                <div id="missionList">
                    <!-- Missions will be populated here -->
                </div>
            </div>

            <!-- Available NPCs -->
            <div class="gm-panel">
                <h3><i class="fas fa-users"></i> Available Team</h3>
                <div id="playerNPCList" style="max-height: 200px; overflow-y: auto;">
                    <!-- Available NPCs will be shown here -->
                </div>
            </div>
        </div>

        <!-- Shared Bastion Sections -->
        <div class="sections-grid" id="sectionsContainer">
            <!-- This will be populated by JavaScript with the upgrade trees -->
        </div>
    </div>

    <!-- Notification System -->
    <div class="notification" id="notification"></div>

    <script>
        // Game State Management
        let currentUser = null;
        let userRole = null;
        // Enhanced Game State with timers and mission assignments
        let gameState = {
            resources: {
                'celestial-power': 1250,
                'celestial-silver': 85,
                'runic-shards': 12,
                'divine-essence': 3,
                'technical-expertise': 0 // Now calculated from NPCs
            },
            sectionStates: {
                luminarium: 'damaged',    // damaged -> cleaning -> cleaned -> online
                sanctum: 'damaged',
                wards: 'damaged',
                throne: 'cleaned',        // Example: ready for repair
                gateway: 'damaged',
                fountain: 'online'        // Example: ready for upgrades
            },
            cleaningTimers: {
                // sectionId: { startTime: timestamp, assignedNPCs: [npcIds], playerDoing: boolean }
            },
            missionAssignments: {
                // missionId: { assignedNPCs: [npcIds], playerDoing: boolean, startTime: timestamp }
            },
            upgrades: {
                luminarium: { research: [], offensive: [], defensive: [] },
                sanctum: { research: [], offensive: [], defensive: [] },
                wards: { research: [], offensive: [], defensive: [] },
                throne: { research: [], offensive: [], defensive: [] },
                gateway: { research: [], offensive: [], defensive: [] },
                fountain: { research: [], offensive: [], defensive: [] }
            },
            npcs: [
                {
                    id: 1,
                    name: "Kade Vex",
                    title: "Ghost Operative",
                    skill: 3,
                    stealth: 4,
                    combat: 1,
                    tech: 2,
                    social: 1,
                    will: 3,
                    loyalty: 85,
                    injury: 0,
                    stress: 0,
                    rank: 1,
                    trait: "Silent Entry ‚Äî Stealth missions ignore first 2 points of required threshold",
                    equipped_item: null,
                    status: 'available' // available, deployed, injured, dead
                },
                {
                    id: 2,
                    name: "Elena Cross",
                    title: "Tech Specialist",
                    skill: 4,
                    stealth: 2,
                    combat: 2,
                    tech: 5,
                    social: 3,
                    will: 4,
                    loyalty: 92,
                    injury: 0,
                    stress: 1,
                    rank: 2,
                    trait: "Data Mining ‚Äî Automatically gains +1 Intel on successful Tech missions",
                    equipped_item: 1, // Equipped with Advanced Scanner
                    status: 'available'
                }
            ],
            items: [
                {
                    id: 1,
                    name: "Advanced Scanner",
                    type: "tech",
                    bonus: { tech: 2 },
                    description: "Grants +2 Tech for complex analysis missions",
                    rarity: "uncommon"
                },
                {
                    id: 2,
                    name: "Stealth Cloak",
                    type: "stealth",
                    bonus: { stealth: 1, will: 1 },
                    description: "Grants +1 Stealth and +1 Will, reduces detection chance",
                    rarity: "rare"
                }
            ],
            missions: [
                {
                    id: 1,
                    title: "Seraphim Archives Infiltration",
                    type: "Stealth",
                    description: "Infiltrate the Seraphim Council archives to steal divine encryption keys.",
                    requirements: {
                        stealth: { min: 5, optimal: 7, perfect: 9 },
                        tech: { bonus: 3, effect: "Disable surveillance systems" }
                    },
                    rewards: {
                        partial: { 'celestial-silver': 50, 'runic-shards': 1 },
                        full: { 'celestial-silver': 100, 'runic-shards': 2, 'divine-essence': 1 },
                        perfect: { 'celestial-silver': 150, 'runic-shards': 3, 'divine-essence': 2, intel: 1 }
                    },
                    consequences: {
                        failure: { stress: 2, heat: 1 },
                        partial: { stress: 1 }
                    },
                    status: "available",
                    duration: "3 days"
                },
                {
                    id: 2,
                    title: "Void Fragment Research",
                    type: "Research", 
                    description: "Study corrupted void fragments to understand their energy patterns.",
                    requirements: {
                        tech: { min: 4, optimal: 6, perfect: 8 },
                        will: { min: 3, effect: "Resist void corruption" }
                    },
                    rewards: {
                        partial: { 'celestial-power': 100, 'runic-shards': 2 },
                        full: { 'celestial-power': 200, 'runic-shards': 4, 'divine-essence': 1 },
                        perfect: { 'celestial-power': 300, 'runic-shards': 6, 'divine-essence': 2, research_data: 1 }
                    },
                    consequences: {
                        failure: { injury: 1, stress: 3 },
                        partial: { stress: 1 }
                    },
                    status: "available",
                    duration: "2 days"
                }
            ],
            sectionRepairCosts: {
                luminarium: { 'celestial-power': 200, 'celestial-silver': 50, 'runic-shards': 5 },
                sanctum: { 'celestial-power': 150, 'celestial-silver': 40, 'divine-essence': 2 },
                wards: { 'celestial-power': 180, 'celestial-silver': 60, 'runic-shards': 3 },
                throne: { 'celestial-power': 120, 'celestial-silver': 30, 'technical-expertise': 3 },
                gateway: { 'celestial-power': 250, 'runic-shards': 8, 'divine-essence': 3 },
                fountain: { 'celestial-power': 100, 'celestial-silver': 80, 'divine-essence': 4 }
            },
            cleaningRewardRanges: {
                'celestial-silver': { min: 10, max: 25 },
                'runic-shards': { min: 1, max: 3 }
            },
            players: ['Jon'], // Only Jon uses this
            activity: [],
            totalCelestialPowerCapacity: 2000, // Maximum possible celestial power
            currentCelestialPowerDrain: 0 // Permanent drain from repairs
        };

        // Authentication System
        const users = {
            'jon': { password: 'bastion2024', role: 'player' },
            'gm': { password: 'gmbastion2024', role: 'gm' }
        };

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const accessCode = document.getElementById('accessCode').value;
            const selectedRole = document.querySelector('.role-btn.active').dataset.role;
            
            // Validate credentials
            if (users[username] && users[username].password === accessCode) {
                if (users[username].role === selectedRole) {
                    login(username, selectedRole);
                } else {
                    showNotification('Invalid role selected for this user', 'error');
                }
            } else {
                showNotification('Invalid credentials', 'error');
            }
        });

        // Role Selection
        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Login Function
        function login(username, role) {
            currentUser = username;
            userRole = role;
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('show');
            document.getElementById('currentUser').textContent = username.charAt(0).toUpperCase() + username.slice(1);
            document.getElementById('userRole').textContent = role.toUpperCase();
            document.getElementById('userRole').className = `role-badge role-${role}`;
            
            if (role === 'gm') {
                document.getElementById('gmDashboard').classList.add('show');
                loadGMDashboard();
            } else {
                document.getElementById('playerDashboard').classList.add('show');
                loadPlayerDashboard();
            }
            
            initializeSections();
            updateAllUpgradeStates(); // Ensure upgrade states are correct on load
            showNotification(`Welcome, ${username}!`);
            logActivity(`${username} logged in as ${role}`);
        }

        // Logout Function
        function logout() {
            currentUser = null;
            userRole = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.remove('show');
            document.getElementById('gmDashboard').classList.remove('show');
            document.getElementById('playerDashboard').classList.remove('show');
        }

        // GM Functions
        function updateGlobalResource(resource, value) {
            if (userRole !== 'gm') return;
            
            gameState.resources[resource] = parseInt(value) || 0;
            updateAllResourceDisplays();
            updateAllUpgradeStates(); // Update upgrade availability
            logActivity(`GM updated ${resource} to ${value}`);
            showNotification(`${resource} updated to ${value}`);
        }

        function addDailyResources() {
            if (userRole !== 'gm') return;
            
            gameState.resources['celestial-power'] += 50;
            gameState.resources['celestial-silver'] += 10;
            updateAllResourceDisplays();
            updateGMResourceInputs();
            updateAllUpgradeStates(); // Update upgrade availability
            logActivity('Daily resources generated');
            showNotification('Daily resources added!');
        }

        function resetResources() {
            if (userRole !== 'gm') return;
            
            if (confirm('Are you sure you want to reset all resources?')) {
                gameState.resources = {
                    'celestial-power': 0,
                    'celestial-silver': 0,
                    'runic-shards': 0,
                    'divine-essence': 0,
                    'technical-expertise': 0
                };
                updateAllResourceDisplays();
                updateGMResourceInputs();
                updateAllUpgradeStates(); // Update upgrade availability
                logActivity('All resources reset by GM');
                showNotification('Resources reset!', 'error');
            }
        }

        function createMission() {
            if (userRole !== 'gm') return;
            
            const title = document.getElementById('mission-title').value;
            const type = document.getElementById('mission-type').value;
            const description = document.getElementById('mission-description').value;
            const rewardsText = document.getElementById('mission-rewards').value;
            
            if (!title || !description) {
                showNotification('Please fill in title and description', 'error');
                return;
            }
            
            const mission = {
                id: Date.now(),
                title,
                type,
                description,
                rewards: parseRewards(rewardsText),
                status: 'available'
            };
            
            gameState.missions.push(mission);
            updateMissionDisplay();
            
            // Clear form
            document.getElementById('mission-title').value = '';
            document.getElementById('mission-description').value = '';
            document.getElementById('mission-rewards').value = '';
            
            logActivity(`New mission created: ${title}`);
            showNotification(`Mission "${title}" created!`);
        }

        function parseRewards(rewardsText) {
            const rewards = {};
            const parts = rewardsText.split(',');
            parts.forEach(part => {
                const match = part.trim().match(/(\d+)\s*(CP|CS|RS|DE|TE)/i);
                if (match) {
                    const amount = parseInt(match[1]);
                    const type = match[2].toLowerCase();
                    const resourceMap = {
                        'cp': 'celestial-power',
                        'cs': 'celestial-silver', 
                        'rs': 'runic-shards',
                        'de': 'divine-essence',
                        'te': 'technical-expertise'
                    };
                    if (resourceMap[type]) {
                        rewards[resourceMap[type]] = amount;
                    }
                }
            });
            return rewards;
        }

        // Player Functions
        function requestUpgrade(sectionId, pathType, upgradeIndex) {
            if (userRole !== 'player') return;
            
            logActivity(`${currentUser} requested upgrade: ${sectionId} ${pathType} ${upgradeIndex}`);
            showNotification('Upgrade request sent to GM');
        }

        // Utility Functions
        function updateAllResourceDisplays() {
            // Calculate tech expertise from NPCs first
            calculateTechExpertise();
            
            // Update player resource display
            Object.keys(gameState.resources).forEach(resource => {
                const playerElement = document.getElementById(`player-${resource}`);
                if (playerElement) {
                    playerElement.textContent = gameState.resources[resource];
                }
            });
            
            // Update calculated tech expertise display
            const techExpertiseDisplay = document.getElementById('calculated-tech-expertise');
            if (techExpertiseDisplay) {
                techExpertiseDisplay.textContent = `${gameState.resources['technical-expertise']} (from ${gameState.npcs.filter(n => n.status === 'available' || n.status === 'deployed').length} NPCs)`;
            }
        }

        function updateGMResourceInputs() {
            Object.keys(gameState.resources).forEach(resource => {
                if (resource !== 'technical-expertise') { // Skip tech expertise since it's calculated
                    const gmElement = document.getElementById(`gm-${resource}`);
                    if (gmElement) {
                        gmElement.value = gameState.resources[resource];
                    }
                }
            });
        }

        function updateMissionDisplay() {
            // This would update the mission board for all users
            // Implementation depends on specific needs
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function logActivity(message) {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            gameState.activity.unshift({ time, message });
            
            // Keep only last 50 activities
            if (gameState.activity.length > 50) {
                gameState.activity = gameState.activity.slice(0, 50);
            }
            
            updateActivityDisplay();
        }

        function updateActivityDisplay() {
            const activityLog = document.getElementById('activityLog');
            if (!activityLog) return;
            
            activityLog.innerHTML = gameState.activity.slice(0, 10).map(activity => `
                <div class="activity-item">
                    <span class="activity-time">${activity.time}</span>
                    <span class="activity-icon">üìù</span>
                    <span>${activity.message}</span>
                </div>
            `).join('');
        }

        function loadGMDashboard() {
            updateGMResourceInputs();
            calculateTechExpertise();
            updateNPCList();
            updateSectionManagement();
            updatePowerCapacity();
            updateAllUpgradeStates();
            
            // Update active missions list
            updateActiveMissionsList();
        }

        function loadPlayerDashboard() {
            updateAllResourceDisplays();
            calculateTechExpertise();
            updateActivityDisplay();
            updateAllUpgradeStates();
            updatePlayerCleaningOptions();
            updatePlayerMissionOptions();
            updateActiveOperations();
            updatePlayerNPCList();
        }

        function updateActiveMissionsList() {
            const container = document.getElementById('activeMissionsList');
            if (!container) return;
            
            const activeMissions = gameState.missions.filter(m => m.status === 'available' || m.status === 'in-progress');
            
            if (activeMissions.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-style: italic;">No active missions</div>';
                return;
            }
            
            container.innerHTML = activeMissions.map(mission => `
                <div style="background: rgba(255,255,255,0.03); border-radius: 6px; padding: 8px; margin-bottom: 6px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; font-size: 0.9rem;">${mission.title}</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">${mission.type} | ${mission.status}</div>
                        </div>
                        <button class="quick-btn" onclick="resolveMission(${mission.id})" style="font-size: 0.7rem; padding: 3px 6px;">Resolve</button>
                    </div>
                </div>
            `).join('');
        }

        function updatePlayerNPCList() {
            const container = document.getElementById('playerNPCList');
            if (!container || userRole !== 'player') return;
            
            const availableNPCs = gameState.npcs.filter(npc => npc.status === 'available');
            
            if (availableNPCs.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-style: italic;">No NPCs available</div>';
                return;
            }
            
            container.innerHTML = availableNPCs.map(npc => `
                <div style="background: rgba(255,255,255,0.03); border-radius: 6px; padding: 8px; margin-bottom: 6px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: var(--gold); font-size: 0.9rem;">${npc.name}</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">${npc.title} | Loyalty: ${npc.loyalty}%</div>
                        </div>
                        <div style="font-size: 0.7rem; text-align: right;">
                            <div>Tech: ${npc.tech} | Stealth: ${npc.stealth}</div>
                            <div>Combat: ${npc.combat} | Social: ${npc.social}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Mission assignment functions
        function playerTakeMission(missionId, playerDoing) {
            if (userRole !== 'player') return;
            
            const mission = gameState.missions.find(m => m.id === missionId);
            if (!mission || mission.status !== 'available') {
                showNotification('Mission not available', 'error');
                return;
            }
            
            // Assign mission
            gameState.missionAssignments[missionId] = {
                assignedNPCs: [],
                playerDoing: playerDoing,
                startTime: Date.now()
            };
            
            mission.status = 'in-progress';
            
            updatePlayerMissionOptions();
            updateActiveOperations();
            logActivity(`Mission taken: ${mission.title} ${playerDoing ? '(by player)' : ''}`);
            showNotification(`Mission "${mission.title}" assigned!`);
        }

        function showMissionNPCAssignment(missionId) {
            // Simplified for now - same as cleaning assignment
            const availableNPCs = gameState.npcs.filter(npc => npc.status === 'available');
            if (availableNPCs.length === 0) {
                showNotification('No NPCs available for assignment', 'error');
                return;
            }
            
            const npcList = availableNPCs.map((npc, index) => `${index + 1}. ${npc.name} (${npc.title})`).join('\n');
            const selection = prompt(`Available NPCs:\n${npcList}\n\nEnter numbers separated by commas (e.g., 1,3):`);
            
            if (selection) {
                const indices = selection.split(',').map(s => parseInt(s.trim()) - 1).filter(i => i >= 0 && i < availableNPCs.length);
                const selectedNPCs = indices.map(i => availableNPCs[i].id);
                
                if (selectedNPCs.length > 0) {
                    const mission = gameState.missions.find(m => m.id === missionId);
                    if (mission) {
                        gameState.missionAssignments[missionId] = {
                            assignedNPCs: selectedNPCs,
                            playerDoing: false,
                            startTime: Date.now()
                        };
                        
                        mission.status = 'in-progress';
                        
                        // Update NPC status
                        selectedNPCs.forEach(npcId => {
                            const npc = gameState.npcs.find(n => n.id === npcId);
                            if (npc) npc.status = 'deployed';
                        });
                        
                        updatePlayerMissionOptions();
                        updateActiveOperations();
                        updatePlayerNPCList();
                        logActivity(`Mission assigned: ${mission.title} (NPCs: ${selectedNPCs.length})`);
                        showNotification(`Mission "${mission.title}" assigned to NPCs!`);
                    }
                }
            }
        }

        // GM mission resolution
        function resolveMission(missionId) {
            if (userRole !== 'gm') return;
            
            const mission = gameState.missions.find(m => m.id === missionId);
            const assignment = gameState.missionAssignments[missionId];
            
            if (!mission || !assignment) {
                showNotification('Mission or assignment not found', 'error');
                return;
            }
            
            const outcome = prompt(`Resolve mission "${mission.title}":\n1. Failure\n2. Partial Success\n3. Full Success\n4. Perfect Success\n\nEnter 1-4:`);
            
            let rewards = {};
            let consequences = {};
            
            switch(outcome) {
                case '1': // Failure
                    rewards = {};
                    consequences = mission.consequences?.failure || {};
                    break;
                case '2': // Partial
                    rewards = mission.rewards?.partial || {};
                    consequences = mission.consequences?.partial || {};
                    break;
                case '3': // Full
                    rewards = mission.rewards?.full || {};
                    consequences = {};
                    break;
                case '4': // Perfect
                    rewards = mission.rewards?.perfect || {};
                    consequences = {};
                    break;
                default:
                    showNotification('Invalid outcome selected', 'error');
                    return;
            }
            
            // Apply rewards
            Object.keys(rewards).forEach(resource => {
                if (gameState.resources[resource] !== undefined) {
                    gameState.resources[resource] += rewards[resource];
                }
            });
            
            // Apply consequences (stress, injury to NPCs)
            if (assignment.assignedNPCs.length > 0) {
                assignment.assignedNPCs.forEach(npcId => {
                    const npc = gameState.npcs.find(n => n.id === npcId);
                    if (npc) {
                        npc.status = 'available';
                        if (consequences.stress) npc.stress += consequences.stress;
                        if (consequences.injury) npc.injury += consequences.injury;
                    }
                });
            }
            
            // Update mission status
            mission.status = 'completed';
            delete gameState.missionAssignments[missionId];
            
            // Update displays
            updateAllResourceDisplays();
            updateGMResourceInputs();
            updateActiveMissionsList();
            updateNPCList();
            
            const outcomeText = ['', 'Failure', 'Partial Success', 'Full Success', 'Perfect Success'][outcome];
            logActivity(`Mission resolved: ${mission.title} - ${outcomeText}`);
            showNotification(`Mission "${mission.title}" resolved: ${outcomeText}`);
        }

        function clearCompletedMissions() {
            if (userRole !== 'gm') return;
            
            const completedCount = gameState.missions.filter(m => m.status === 'completed').length;
            if (completedCount === 0) {
                showNotification('No completed missions to clear');
                return;
            }
            
            if (confirm(`Clear ${completedCount} completed missions?`)) {
                gameState.missions = gameState.missions.filter(m => m.status !== 'completed');
                updateActiveMissionsList();
                logActivity(`${completedCount} completed missions cleared`);
                showNotification(`${completedCount} completed missions cleared`);
            }
        }

        // Timer update system with enhanced real-time updates
        function startTimerUpdates() {
            setInterval(() => {
                checkCleaningCompletion();
                updateTimerDisplays();
                
                // Update campaign stats
                const statsElement = document.getElementById('campaignStats');
                if (statsElement && userRole === 'gm') {
                    const activeNPCs = gameState.npcs.filter(npc => npc.status === 'available' || npc.status === 'deployed').length;
                    const activeMissions = gameState.missions.filter(m => m.status === 'available' || m.status === 'in-progress').length;
                    const onlineSections = Object.values(gameState.sectionStates).filter(state => state === 'online').length;
                    const powerEfficiency = Math.round(((gameState.totalCelestialPowerCapacity - gameState.currentCelestialPowerDrain) / gameState.totalCelestialPowerCapacity) * 100);
                    
                    statsElement.textContent = `NPCs: ${activeNPCs} | Active Missions: ${activeMissions} | Online Sections: ${onlineSections}/6 | Power Efficiency: ${powerEfficiency}%`;
                }
            }, 30000); // Update every 30 seconds
            
            // More frequent updates for timers
            setInterval(() => {
                updateTimerDisplays();
            }, 60000); // Update every minute
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-focus username field
            document.getElementById('username').focus();
            
            // Start timer updates
            startTimerUpdates();
            
            // Add some initial activity for demo
            if (gameState.activity.length === 0) {
                const now = new Date();
                const time = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                gameState.activity.push(
                    { time: time, message: 'Bastion Management System initialized' },
                    { time: time, message: 'Daily power generation cycle started' },
                    { time: time, message: 'All systems operational' }
                );
            }
        });

        // Section definitions with all upgrade data
        const sections = {
            luminarium: {
                title: "üèõÔ∏è Luminarium",
                description: "Main Power Generator",
                paths: {
                    research: [
                        { name: "Pulse Harmonization", description: "Increases efficiency of all other sections by 10% when fully operational. Also improves astral propulsion control.", cost: { 'celestial-power': 100, 'technical-expertise': 2 } },
                        { name: "Celestial Mapping", description: "Tracks divine energy sources throughout the cosmos, identifying potential grace reservoirs and anomalies.", cost: { 'celestial-power': 150, 'runic-shards': 3 } },
                        { name: "Grace Recycling", description: "Recovers spent grace for reuse in critical systems, increasing operational duration between refueling.", cost: { 'celestial-power': 200, 'divine-essence': 1 } }
                    ],
                    offensive: [
                        { name: "Radiant Overcharge", description: "Once per day, release a radiant pulse that deals light damage to all enemies within the Bastion.", cost: { 'celestial-power': 120, 'celestial-silver': 50 } },
                        { name: "Focused Beam", description: "Channel concentrated energy into a devastating attack against a single target, effective against heavily shielded foes.", cost: { 'celestial-power': 180, 'runic-shards': 4 } },
                        { name: "Grace Storm", description: "Create a field of wild grace energy that disrupts magical effects and damages corrupt entities.", cost: { 'celestial-power': 250, 'divine-essence': 2 } }
                    ],
                    defensive: [
                        { name: "Failsafe Core", description: "Prevents total Bastion failure once per major event, triggering a temporary energy field protecting all sections.", cost: { 'celestial-power': 200, 'technical-expertise': 3 } },
                        { name: "Adaptive Shielding", description: "Automatically adjusts defenses based on the nature of incoming threats, offering optimal protection.", cost: { 'celestial-power': 300, 'runic-shards': 5 } },
                        { name: "Dimensional Anchor", description: "Prevents forced translocation of the Bastion by hostile entities, ensuring strategic position control.", cost: { 'celestial-power': 400, 'divine-essence': 3 } }
                    ]
                }
            },
            sanctum: {
                title: "‚õ™ Sanctum",
                description: "Purification & Spiritual Focus",
                paths: {
                    research: [
                        { name: "Soul Resonance Mapping", description: "Grants insight into corrupted items or beings, enabling better exorcism or artifact cleansing.", cost: { 'celestial-power': 80, 'divine-essence': 1 } },
                        { name: "Divine Communion", description: "Establish temporary communication with higher divine powers for guidance on critical matters.", cost: { 'celestial-power': 150, 'divine-essence': 2 } },
                        { name: "Ethereal Perception", description: "Detect spiritual anomalies across dimensional boundaries, providing early warning of threats.", cost: { 'celestial-power': 200, 'runic-shards': 3 } }
                    ],
                    offensive: [
                        { name: "Judgment Flare", description: "Empower allies to deal radiant damage when fighting corrupted foes. Can also blind nearby threats.", cost: { 'celestial-power': 100, 'celestial-silver': 40 } },
                        { name: "Banishment Wave", description: "Force extraplanar entities back to their native dimensions, effective against invading forces.", cost: { 'celestial-power': 180, 'divine-essence': 2 } },
                        { name: "Purifying Flame", description: "Create weapons of pure spiritual energy that bypass physical defenses.", cost: { 'celestial-power': 250, 'divine-essence': 3 } }
                    ],
                    defensive: [
                        { name: "Sacred Veil", description: "Aura around the Sanctum slowly purifies corruption in adjacent areas.", cost: { 'celestial-power': 120, 'runic-shards': 2 } },
                        { name: "Spiritual Barrier", description: "Block attempts at spiritual invasion or possession, protecting inhabitants from psychic attacks.", cost: { 'celestial-power': 200, 'divine-essence': 2 } },
                        { name: "Blessing of Protection", description: "Grant allies temporary immunity to specific types of corruption or negative energy.", cost: { 'celestial-power': 300, 'divine-essence': 4 } }
                    ]
                }
            },
            wards: {
                title: "üõ°Ô∏è Wards",
                description: "Defensive Matrix",
                paths: {
                    research: [
                        { name: "Sigil Scripting", description: "Inscribe temporary protective runes before dangerous missions, adding protection to allies.", cost: { 'celestial-power': 90, 'technical-expertise': 2 } },
                        { name: "Breach Analysis", description: "When wards are compromised, gain perfect understanding of the method used, preventing future breaches.", cost: { 'celestial-power': 160, 'runic-shards': 3 } },
                        { name: "Reactive Mathematics", description: "Defensive formulas that adapt to new threats, gradually becoming more effective against recurring enemies.", cost: { 'celestial-power': 220, 'technical-expertise': 4 } }
                    ],
                    offensive: [
                        { name: "Heaven's Volley", description: "Install celestial cannon arrays on the Bastion. Can be fired once per day to target incoming threats.", cost: { 'celestial-power': 150, 'celestial-silver': 60 } },
                        { name: "Counter-Sigils", description: "When defensive wards are struck, they reflect a portion of the attack back at the source.", cost: { 'celestial-power': 200, 'runic-shards': 4 } },
                        { name: "Binding Protocols", description: "Create temporary fields that restrict movement and abilities of hostile entities within range.", cost: { 'celestial-power': 280, 'divine-essence': 2 } }
                    ],
                    defensive: [
                        { name: "Layered Shielding", description: "Enhances physical and magical ward structures, increasing durability against siege effects.", cost: { 'celestial-power': 140, 'technical-expertise': 3 } },
                        { name: "Phasing Barriers", description: "Defenses exist partially out of phase, making them harder to target and destroy.", cost: { 'celestial-power': 220, 'runic-shards': 5 } },
                        { name: "Bastion Memory", description: "The structure 'remembers' previous attacks, automatically reinforcing against similar future threats.", cost: { 'celestial-power': 350, 'divine-essence': 3 } }
                    ]
                }
            },
            throne: {
                title: "üëë Throne Room",
                description: "Command Center",
                paths: {
                    research: [
                        { name: "Battle Archives", description: "Gain tactical insights post-battle. Ask one additional question from any information-gathering source.", cost: { 'celestial-power': 100, 'technical-expertise': 2 } },
                        { name: "Strategic Modeling", description: "Create magical simulations to test tactics before implementation, improving success rates.", cost: { 'celestial-power': 180, 'runic-shards': 3 } },
                        { name: "Command Linguistics", description: "Enhanced communication with allies across vast distances, regardless of language barriers.", cost: { 'celestial-power': 240, 'divine-essence': 2 } }
                    ],
                    offensive: [
                        { name: "Battle Synchrony", description: "Designate one mission per week as 'coordinated,' giving a +1 bonus to all rolls due to superior planning.", cost: { 'celestial-power': 120, 'celestial-silver': 50 } },
                        { name: "Command Authority", description: "Voice carries supernatural weight, causing lesser enemies to hesitate or flee.", cost: { 'celestial-power': 200, 'divine-essence': 2 } },
                        { name: "Tactical Inspiration", description: "During critical moments, can grant allies an unexpected second wind or insight.", cost: { 'celestial-power': 300, 'divine-essence': 3 } }
                    ],
                    defensive: [
                        { name: "Iron Mandate", description: "Enemies attempting to sabotage command face higher resistance or misdirection.", cost: { 'celestial-power': 110, 'technical-expertise': 2 } },
                        { name: "Protected Awareness", description: "Command staff cannot be magically scried upon or have thoughts read without their knowledge.", cost: { 'celestial-power': 190, 'runic-shards': 4 } },
                        { name: "Contingency Protocols", description: "If command is compromised, automated systems maintain basic functions until control is restored.", cost: { 'celestial-power': 280, 'technical-expertise': 5 } }
                    ]
                }
            },
            gateway: {
                title: "üåÄ Gateway",
                description: "Teleportation Hub",
                paths: {
                    research: [
                        { name: "Harmonic Coordinates", description: "Unlock hidden realms or rare mission sites with unique rewards.", cost: { 'celestial-power': 130, 'runic-shards': 3 } },
                        { name: "Sympathetic Mapping", description: "After visiting a location once, can return with perfect accuracy regardless of wards or barriers.", cost: { 'celestial-power': 200, 'technical-expertise': 3 } },
                        { name: "Beacon Understanding", description: "Ability to analyze and potentially replicate transportation methods of other beings.", cost: { 'celestial-power': 270, 'divine-essence': 2 } }
                    ],
                    offensive: [
                        { name: "Tactical Insertion", description: "Once per session, deploy a team directly into a known hostile location bypassing travel.", cost: { 'celestial-power': 160, 'celestial-silver': 70 } },
                        { name: "Portal Strike", description: "Open momentary gateways to launch attacks from unexpected angles.", cost: { 'celestial-power': 230, 'runic-shards': 4 } },
                        { name: "Dimensional Shear", description: "Create unstable planar intersections that damage creatures caught between worlds.", cost: { 'celestial-power': 320, 'divine-essence': 3 } }
                    ],
                    defensive: [
                        { name: "Interdiction Array", description: "Nullifies teleportation-based infiltration attempts into the Bastion.", cost: { 'celestial-power': 150, 'technical-expertise': 3 } },
                        { name: "Escape Protocols", description: "In dire emergencies, automatically evacuates critical personnel to predetermined safe locations.", cost: { 'celestial-power': 220, 'runic-shards': 5 } },
                        { name: "Planar Anchoring", description: "Stabilizes local reality, preventing dimensional manipulation within the Bastion's influence.", cost: { 'celestial-power': 350, 'divine-essence': 4 } }
                    ]
                }
            },
            fountain: {
                title: "‚õ≤ Fountain of Grace",
                description: "Healing Center",
                paths: {
                    research: [
                        { name: "Graceflow Optimization", description: "Increases passive generation of celestial silver and healing effectiveness.", cost: { 'celestial-power': 110, 'technical-expertise': 2 } },
                        { name: "Essence Analysis", description: "Identify the nature and source of injuries or afflictions with perfect accuracy.", cost: { 'celestial-power': 170, 'divine-essence': 1 } },
                        { name: "Resurrection Protocols", description: "Establish foundation for potential revival of fatally wounded allies under specific conditions.", cost: { 'celestial-power': 300, 'divine-essence': 4 } }
                    ],
                    offensive: [
                        { name: "Blessing Surge", description: "Store divine interventions for use in dire situations.", cost: { 'celestial-power': 140, 'celestial-silver': 60 } },
                        { name: "Purifying Cascade", description: "Transform fountain energies into damaging wave against unholy entities.", cost: { 'celestial-power': 210, 'divine-essence': 2 } },
                        { name: "Lifeforce Manipulation", description: "Temporarily enhance allies' physical capabilities beyond normal limits.", cost: { 'celestial-power': 290, 'divine-essence': 3 } }
                    ],
                    defensive: [
                        { name: "Aegis Misting", description: "Emergency regenerative mist healing allies in adjacent sections.", cost: { 'celestial-power': 120, 'runic-shards': 3 } },
                        { name: "Stasis Field", description: "Preserve critically wounded in suspended animation until proper healing is available.", cost: { 'celestial-power': 200, 'technical-expertise': 4 } },
                        { name: "Vitality Shield", description: "Convert incoming damage to healing energy with diminishing returns.", cost: { 'celestial-power': 320, 'divine-essence': 4 } }
                    ]
                }
            }
        };

        // Resource icons mapping
        const resourceIcons = {
            'celestial-power': '‚ö°',
            'celestial-silver': 'ü•à',
            'runic-shards': 'üíé',
            'divine-essence': '‚ú®',
            'technical-expertise': 'üî¨'
        };

        function initializeSections() {
            const container = document.getElementById('sectionsContainer');
            if (!container) return;
            
            container.innerHTML = ''; // Clear existing content
            
            Object.keys(sections).forEach(sectionId => {
                const section = sections[sectionId];
                const sectionState = gameState.sectionStates[sectionId];
                const isOnline = sectionState === 'online';
                const totalUpgrades = Object.values(section.paths).reduce((sum, path) => sum + path.length, 0);
                const completedUpgrades = Object.values(gameState.upgrades[sectionId]).reduce((sum, upgrades) => sum + upgrades.length, 0);
                const progressPercentage = isOnline ? (completedUpgrades / totalUpgrades) * 100 : 0;
                
                const stateColor = getSectionStateColor(sectionState);
                const stateText = getSectionStateText(sectionState);
                
                // Check if section is currently being cleaned
                const isBeingCleaned = gameState.cleaningTimers[sectionId];
                let timerInfo = '';
                if (isBeingCleaned) {
                    const remaining = getTimeRemaining(isBeingCleaned.startTime, 72);
                    timerInfo = remaining ? `‚è±Ô∏è ${formatTimeRemaining(remaining)} remaining` : '‚è±Ô∏è Almost complete!';
                }
                
                const sectionHtml = `
                    <div class="section-card" id="${sectionId}" style="${!isOnline ? 'opacity: 0.6; border-color: ' + stateColor + ';' : ''}">
                        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                            <div class="section-title" style="color: var(--gold); font-family: 'Orbitron', monospace; font-size: 1.3rem; font-weight: 700;">${section.title}</div>
                            <div class="section-progress" style="display: flex; align-items: center; gap: 10px;">
                                <div class="progress-bar" style="width: 80px; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                                    <div class="progress-fill" style="height: 100%; background: linear-gradient(90deg, var(--gold), var(--cyan)); width: ${progressPercentage}%; transition: width 0.5s ease;"></div>
                                </div>
                                <span class="progress-text" style="font-size: 0.8rem; color: var(--text-secondary);">${isOnline ? completedUpgrades + '/' + totalUpgrades : 'OFFLINE'}</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">${section.description}</p>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; font-weight: 600; color: ${stateColor};">${stateText}</div>
                                ${timerInfo ? `<div style="font-size: 0.8rem; color: var(--gold);">${timerInfo}</div>` : ''}
                                ${!isOnline ? '<div style="font-size: 0.8rem; color: var(--text-secondary);">Upgrades locked until online</div>' : ''}
                            </div>
                        </div>
                        
                        ${isOnline ? `
                        <div class="paths-container" style="display: flex; flex-direction: column; gap: 12px;">
                            ${Object.keys(section.paths).map(pathType => {
                                const pathUpgrades = gameState.upgrades[sectionId][pathType].length;
                                const totalPathUpgrades = section.paths[pathType].length;
                                const pathColor = pathType === 'research' ? 'var(--cyan)' : pathType === 'offensive' ? 'var(--red)' : 'var(--green)';
                                const pathIcon = pathType === 'research' ? 'microscope' : pathType === 'offensive' ? 'sword' : 'shield-alt';
                                
                                return `
                                    <div class="path ${pathType}" style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden;">
                                        <div class="path-header" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; cursor: pointer; transition: all 0.3s ease; color: ${pathColor};" onclick="togglePath('${sectionId}', '${pathType}')">
                                            <div class="path-name" style="font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                                <i class="fas fa-${pathIcon}"></i>
                                                ${pathType.charAt(0).toUpperCase() + pathType.slice(1)} Path
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span style="font-size: 0.8rem; color: var(--text-secondary);">${pathUpgrades}/${totalPathUpgrades}</span>
                                                <span class="path-toggle" style="transition: transform 0.3s ease;">‚ñº</span>
                                            </div>
                                        </div>
                                        <div class="upgrades-list" id="${sectionId}-${pathType}-upgrades" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease;">
                                            ${section.paths[pathType].map((upgrade, index) => {
                                                const isCompleted = gameState.upgrades[sectionId][pathType].includes(index);
                                                const canAfford = canAffordUpgrade(upgrade.cost);
                                                let statusClass, statusText, buttonDisplay;
                                                
                                                if (isCompleted) {
                                                    statusClass = 'status-completed';
                                                    statusText = 'Completed';
                                                    buttonDisplay = 'none';
                                                } else if (canAfford) {
                                                    statusClass = 'status-available';
                                                    statusText = 'Available';
                                                    buttonDisplay = 'inline-block';
                                                } else {
                                                    statusClass = 'status-locked';
                                                    statusText = 'Locked';
                                                    buttonDisplay = 'inline-block';
                                                }
                                                
                                                return `
                                                    <div class="upgrade-item" id="${sectionId}-${pathType}-${index}" style="background: rgba(255, 255, 255, 0.02); margin: 0 12px 12px 12px; border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 15px; transition: all 0.3s ease;">
                                                        <div class="upgrade-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                                            <div class="upgrade-name" style="font-weight: 600; color: var(--text-primary); font-size: 1rem;">${upgrade.name}</div>
                                                            <span class="upgrade-status ${statusClass}" style="padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase;">${statusText}</span>
                                                        </div>
                                                        <div class="upgrade-description" style="color: var(--text-secondary); line-height: 1.4; margin-bottom: 12px; font-size: 0.9rem;">${upgrade.description}</div>
                                                        <div class="upgrade-footer" style="display: flex; justify-content: space-between; align-items: center;">
                                                            <div class="upgrade-cost" style="display: flex; gap: 12px; font-size: 0.85rem;">
                                                                ${Object.entries(upgrade.cost).map(([resource, amount]) => `
                                                                    <span class="cost-item" style="display: flex; align-items: center; gap: 4px; color: var(--text-secondary);">
                                                                        ${resourceIcons[resource]} ${amount}
                                                                    </span>
                                                                `).join('')}
                                                            </div>
                                                            ${userRole === 'gm' ? `
                                                                <button class="purchase-btn" style="background: linear-gradient(45deg, var(--gold), var(--gold-dark)); color: #000; border: none; padding: 6px 12px; border-radius: 15px; font-weight: 600; cursor: pointer; font-size: 0.8rem; display: ${buttonDisplay};" onclick="purchaseUpgrade('${sectionId}', '${pathType}', ${index})" ${!canAfford || isCompleted ? 'disabled' : ''}>
                                                                    ${isCompleted ? 'Completed' : 'Purchase'}
                                                                </button>
                                                            ` : `
                                                                <button class="upgrade-request-btn" style="background: var(--purple); color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; display: ${isCompleted ? 'none' : 'inline-block'};" onclick="requestUpgrade('${sectionId}', '${pathType}', ${index})">
                                                                    Request
                                                                </button>
                                                            `}
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ` : `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-tools" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <div>This section is ${sectionState.toUpperCase()}</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">
                                ${sectionState === 'damaged' ? 'Needs cleaning before repair' : 
                                  sectionState === 'cleaning' ? 'Currently being cleaned' :
                                  sectionState === 'cleaned' ? 'Ready for repair' : 'Complete repairs to access upgrades'}
                            </div>
                            ${timerInfo ? `<div style="font-size: 0.9rem; margin-top: 10px; color: var(--gold);">${timerInfo}</div>` : ''}
                        </div>
                        `}
                    </div>
                `;
                container.innerHTML += sectionHtml;
            });
        }

        function togglePath(sectionId, pathType) {
            const upgradesList = document.getElementById(`${sectionId}-${pathType}-upgrades`);
            const pathElement = upgradesList.closest('.path');
            const isExpanded = pathElement.classList.contains('expanded');
            
            if (isExpanded) {
                pathElement.classList.remove('expanded');
                upgradesList.style.maxHeight = '0';
                pathElement.querySelector('.path-toggle').style.transform = 'rotate(0deg)';
            } else {
                pathElement.classList.add('expanded');
                upgradesList.style.maxHeight = '1000px';
                pathElement.querySelector('.path-toggle').style.transform = 'rotate(180deg)';
            }
        }

        function canAffordUpgrade(costs) {
            for (let resource in costs) {
                if (gameState.resources[resource] < costs[resource]) {
                    return false;
                }
            }
            return true;
        }

        function purchaseUpgrade(sectionId, pathType, upgradeIndex) {
            if (userRole !== 'gm') return;
            
            // Check if section is online
            if (gameState.sectionStates[sectionId] !== 'online') {
                showNotification(`${sectionId} must be online before upgrades can be purchased!`, 'error');
                return;
            }
            
            const upgrade = sections[sectionId].paths[pathType][upgradeIndex];
            
            if (canAffordUpgrade(upgrade.cost) && !gameState.upgrades[sectionId][pathType].includes(upgradeIndex)) {
                // Deduct costs
                for (let resource in upgrade.cost) {
                    gameState.resources[resource] -= upgrade.cost[resource];
                }
                
                // Add upgrade
                gameState.upgrades[sectionId][pathType].push(upgradeIndex);
                
                // Update displays
                updateAllResourceDisplays();
                updateGMResourceInputs();
                updateUpgradeDisplay(sectionId, pathType, upgradeIndex);
                updateSectionProgress(sectionId);
                
                logActivity(`Upgrade purchased: ${upgrade.name}`);
                showNotification(`Purchased: ${upgrade.name}`);
            } else if (!canAffordUpgrade(upgrade.cost)) {
                showNotification('Insufficient resources for this upgrade!', 'error');
            }
        }

        function updateUpgradeDisplay(sectionId, pathType, upgradeIndex) {
            const upgradeElement = document.getElementById(`${sectionId}-${pathType}-${upgradeIndex}`);
            if (upgradeElement) {
                const statusElement = upgradeElement.querySelector('.upgrade-status');
                const buttonElement = upgradeElement.querySelector('.purchase-btn, .upgrade-request-btn');
                
                statusElement.textContent = 'Completed';
                statusElement.className = 'upgrade-status status-completed';
                if (buttonElement) buttonElement.style.display = 'none';
            }
        }

        function updateSectionProgress(sectionId) {
            const total = Object.values(sections[sectionId].paths).reduce((sum, path) => sum + path.length, 0);
            const completed = Object.values(gameState.upgrades[sectionId]).reduce((sum, upgrades) => sum + upgrades.length, 0);
            const percentage = (completed / total) * 100;
            
            const progressFill = document.querySelector(`#${sectionId} .progress-fill`);
            const progressText = document.querySelector(`#${sectionId} .progress-text`);
            
            if (progressFill && progressText) {
                progressFill.style.width = percentage + '%';
                progressText.textContent = `${completed}/${total}`;
            }
        }

        // Enhanced functionality for complex systems

        // Timer and time management
        function getTimeRemaining(startTime, durationHours) {
            const now = Date.now();
            const elapsed = now - startTime;
            const totalDuration = durationHours * 60 * 60 * 1000; // Convert hours to milliseconds
            const remaining = totalDuration - elapsed;
            
            if (remaining <= 0) return null;
            
            const hours = Math.floor(remaining / (60 * 60 * 1000));
            const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
            
            return { hours, minutes, total: remaining };
        }

        function formatTimeRemaining(timeObj) {
            if (!timeObj) return 'Complete';
            return `${timeObj.hours}h ${timeObj.minutes}m`;
        }

        // Generate random cleaning rewards
        function generateCleaningRewards() {
            const rewards = {};
            Object.keys(gameState.cleaningRewardRanges).forEach(resource => {
                const range = gameState.cleaningRewardRanges[resource];
                const amount = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
                rewards[resource] = amount;
            });
            return rewards;
        }

        // Calculate tech expertise from NPCs
        function calculateTechExpertise() {
            let totalTech = 0;
            gameState.npcs.forEach(npc => {
                if (npc.status === 'available' || npc.status === 'deployed') {
                    totalTech += npc.tech;
                    // Add equipment bonuses
                    if (npc.equipped_item) {
                        const item = gameState.items.find(i => i.id === npc.equipped_item);
                        if (item && item.bonus.tech) {
                            totalTech += item.bonus.tech;
                        }
                    }
                }
            });
            gameState.resources['technical-expertise'] = totalTech;
            return totalTech;
        }

        // Section Management Functions
        function getSectionStateColor(state) {
            switch(state) {
                case 'damaged': return 'var(--red)';
                case 'cleaning': return 'var(--gold)';
                case 'cleaned': return 'var(--cyan)';
                case 'online': return 'var(--green)';
                default: return 'var(--text-secondary)';
            }
        }

        function getSectionStateText(state) {
            switch(state) {
                case 'damaged': return 'DAMAGED - Needs Cleaning';
                case 'cleaning': return 'CLEANING - In Progress';
                case 'cleaned': return 'CLEANED - Needs Repair';
                case 'online': return 'ONLINE - Ready for Upgrades';
                default: return 'UNKNOWN';
            }
        }

        function startCleaning(sectionId, assignedNPCs = [], playerDoing = false) {
            if (gameState.sectionStates[sectionId] !== 'damaged') {
                showNotification('Section is not damaged!', 'error');
                return;
            }

            // Check if player can only clean one section
            if (userRole === 'player') {
                const activeCleaning = Object.keys(gameState.cleaningTimers).length;
                if (activeCleaning >= 1) {
                    showNotification('You can only clean one section at a time!', 'error');
                    return;
                }
            }

            // Update section state and start timer
            gameState.sectionStates[sectionId] = 'cleaning';
            gameState.cleaningTimers[sectionId] = {
                startTime: Date.now(),
                assignedNPCs: assignedNPCs,
                playerDoing: playerDoing
            };

            // Update NPC status if assigned
            if (assignedNPCs.length > 0) {
                assignedNPCs.forEach(npcId => {
                    const npc = gameState.npcs.find(n => n.id === npcId);
                    if (npc) npc.status = 'deployed';
                });
            }

            updateSectionManagement();
            updatePlayerCleaningOptions();
            updateActiveOperations();
            logActivity(`Cleaning started on ${sectionId} ${playerDoing ? 'by player' : 'by NPCs'}`);
            showNotification(`Cleaning started on ${sectionId}! Will complete in 72 hours.`);
        }

        function checkCleaningCompletion() {
            Object.keys(gameState.cleaningTimers).forEach(sectionId => {
                const timer = gameState.cleaningTimers[sectionId];
                const remaining = getTimeRemaining(timer.startTime, 72);
                
                if (!remaining) {
                    // Cleaning complete!
                    completeCleaning(sectionId);
                }
            });
        }

        function completeCleaning(sectionId) {
            const timer = gameState.cleaningTimers[sectionId];
            if (!timer) return;

            // Generate and award random rewards
            const rewards = generateCleaningRewards();
            Object.keys(rewards).forEach(resource => {
                if (gameState.resources[resource] !== undefined) {
                    gameState.resources[resource] += rewards[resource];
                }
            });

            // Update section state
            gameState.sectionStates[sectionId] = 'cleaned';

            // Free up assigned NPCs
            if (timer.assignedNPCs.length > 0) {
                timer.assignedNPCs.forEach(npcId => {
                    const npc = gameState.npcs.find(n => n.id === npcId);
                    if (npc) npc.status = 'available';
                });
            }

            // Remove timer
            delete gameState.cleaningTimers[sectionId];

            // Update displays
            updateAllResourceDisplays();
            updateGMResourceInputs();
            updateSectionManagement();
            updatePlayerCleaningOptions();
            updateActiveOperations();
            updateNPCList();

            const rewardText = Object.entries(rewards).map(([resource, amount]) => {
                const icons = {
                    'celestial-silver': 'ü•à',
                    'runic-shards': 'üíé'
                };
                return `${icons[resource] || ''}${amount} ${resource}`;
            }).join(', ');

            logActivity(`${sectionId} cleaning completed - rewards: ${rewardText}`);
            showNotification(`${sectionId} cleaning completed! Rewards: ${rewardText}`);
        }

        function forceCompleteCleaning(sectionId) {
            if (userRole !== 'gm') return;
            if (gameState.cleaningTimers[sectionId]) {
                completeCleaning(sectionId);
                showNotification(`Forced completion of ${sectionId} cleaning`);
            }
        }

        function repairSection(sectionId) {
            if (userRole !== 'gm') return;
            if (gameState.sectionStates[sectionId] !== 'cleaned') {
                showNotification('Section must be cleaned first!', 'error');
                return;
            }

            const costs = gameState.sectionRepairCosts[sectionId];
            
            // Check if we can afford it
            for (let resource in costs) {
                if (resource === 'celestial-power') {
                    if (gameState.resources[resource] < costs[resource]) {
                        showNotification('Insufficient Celestial Power for repair!', 'error');
                        return;
                    }
                } else if (gameState.resources[resource] < costs[resource]) {
                    showNotification(`Insufficient ${resource} for repair!`, 'error');
                    return;
                }
            }

            // Deduct costs
            Object.keys(costs).forEach(resource => {
                gameState.resources[resource] -= costs[resource];
            });

            // Add permanent celestial power drain
            const powerDrain = costs['celestial-power'] * 0.1;
            gameState.currentCelestialPowerDrain += powerDrain;

            // Update section state
            gameState.sectionStates[sectionId] = 'online';
            
            updateAllResourceDisplays();
            updateGMResourceInputs();
            updateSectionManagement();
            updatePowerCapacity();
            logActivity(`Section ${sectionId} repaired - now online`);
            showNotification(`${sectionId} repaired and online!`);
        }

        function updatePowerCapacity() {
            const effectiveCapacity = gameState.totalCelestialPowerCapacity - gameState.currentCelestialPowerDrain;
            const powerDisplay = document.getElementById('power-capacity');
            if (powerDisplay) {
                powerDisplay.textContent = `/ ${effectiveCapacity} (drain: ${Math.round(gameState.currentCelestialPowerDrain)})`;
            }
        }

        function updateSectionManagement() {
            const container = document.getElementById('sectionManagement');
            if (!container) return;
            
            container.innerHTML = Object.keys(gameState.sectionStates).map(sectionId => {
                const state = gameState.sectionStates[sectionId];
                const stateColor = getSectionStateColor(state);
                const stateText = getSectionStateText(state);
                
                let actionButton = '';
                let timerDisplay = '';
                
                if (state === 'damaged') {
                    actionButton = `<button class="quick-btn" onclick="startCleaning('${sectionId}')" style="font-size: 0.8rem;">Start Cleaning</button>`;
                } else if (state === 'cleaning') {
                    const timer = gameState.cleaningTimers[sectionId];
                    if (timer) {
                        const remaining = getTimeRemaining(timer.startTime, 72);
                        timerDisplay = `<div style="font-size: 0.7rem; color: var(--gold);">Time: ${formatTimeRemaining(remaining)}</div>`;
                        actionButton = userRole === 'gm' ? 
                            `<button class="quick-btn" onclick="forceCompleteCleaning('${sectionId}')" style="font-size: 0.8rem;">Force Complete</button>` : '';
                    }
                } else if (state === 'cleaned') {
                    const costs = gameState.sectionRepairCosts[sectionId];
                    const costText = Object.entries(costs).map(([resource, amount]) => {
                        const icons = {
                            'celestial-power': '‚ö°',
                            'celestial-silver': 'ü•à',
                            'runic-shards': 'üíé',
                            'divine-essence': '‚ú®',
                            'technical-expertise': 'üî¨'
                        };
                        return `${icons[resource]}${amount}`;
                    }).join(' ');
                    actionButton = userRole === 'gm' ? `
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 5px;">Cost: ${costText}</div>
                        <button class="quick-btn" onclick="repairSection('${sectionId}')" style="font-size: 0.8rem;">Repair</button>
                    ` : '';
                }
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        <div>
                            <div style="font-weight: 600;">${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}</div>
                            <div style="font-size: 0.8rem; color: ${stateColor};">${stateText}</div>
                            ${timerDisplay}
                        </div>
                        <div style="text-align: right;">
                            ${actionButton}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Enhanced NPC Management Functions
        function updateNPCList() {
            const container = document.getElementById('npcList');
            if (!container) return;
            
            container.innerHTML = gameState.npcs.map((npc, index) => {
                const totalStats = npc.skill + npc.stealth + npc.combat + npc.tech + npc.social + npc.will;
                const statusColor = npc.status === 'available' ? 'var(--green)' : npc.status === 'deployed' ? 'var(--gold)' : 'var(--red)';
                
                const equippedItem = npc.equipped_item ? gameState.items.find(i => i.id === npc.equipped_item) : null;
                
                return `
                    <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; margin-bottom: 8px; border-left: 3px solid ${statusColor};" data-npc-id="${npc.id}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <div style="font-weight: 600; color: var(--gold);">${npc.name}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${npc.title}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.8rem; color: ${statusColor}; font-weight: 600;">${npc.status.toUpperCase()}</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">Rank ${npc.rank} | Loyalty ${npc.loyalty}%</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-bottom: 8px; font-size: 0.8rem;">
                            <div>SKL: ${npc.skill}</div>
                            <div>STL: ${npc.stealth}</div>
                            <div>CMB: ${npc.combat}</div>
                            <div>TCH: ${npc.tech}</div>
                            <div>SOC: ${npc.social}</div>
                            <div>WIL: ${npc.will}</div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--cyan); margin-bottom: 8px;">${npc.trait}</div>
                        ${equippedItem ? `<div style="font-size: 0.7rem; color: var(--purple);">üì¶ ${equippedItem.name}</div>` : ''}
                        <div style="display: flex; gap: 5px; margin-top: 8px;">
                            <input type="checkbox" class="npc-select" data-npc-id="${npc.id}" style="margin-right: 5px;">
                            <button class="quick-btn" onclick="editNPC(${npc.id})" style="font-size: 0.7rem; padding: 4px 8px;">Edit</button>
                            <button class="quick-btn" onclick="manageNPCEquipment(${npc.id})" style="font-size: 0.7rem; padding: 4px 8px;">Equipment</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateNPCStats();
        }

        function updateNPCStats() {
            const activeCount = gameState.npcs.filter(npc => npc.status === 'available' || npc.status === 'deployed').length;
            const totalTech = gameState.npcs.reduce((sum, npc) => sum + (npc.status === 'available' || npc.status === 'deployed' ? npc.tech : 0), 0);
            const avgLoyalty = Math.round(gameState.npcs.reduce((sum, npc) => sum + npc.loyalty, 0) / gameState.npcs.length);
            
            const activeElement = document.getElementById('activeNPCCount');
            const techElement = document.getElementById('totalTechFromNPCs');
            const loyaltyElement = document.getElementById('avgLoyalty');
            
            if (activeElement) activeElement.textContent = activeCount;
            if (techElement) techElement.textContent = totalTech;
            if (loyaltyElement) loyaltyElement.textContent = avgLoyalty + '%';
        }

        function createNPC() {
            if (userRole !== 'gm') return;
            
            const name = prompt('NPC Name:');
            if (!name) return;
            
            const title = prompt('NPC Title/Role:');
            if (!title) return;
            
            // Get custom stats or use random
            const useCustom = confirm('Use custom stats? (Cancel for random generation)');
            let stats = {};
            
            if (useCustom) {
                stats.skill = parseInt(prompt('Skill (1-6):', '3')) || 3;
                stats.stealth = parseInt(prompt('Stealth (1-6):', '3')) || 3;
                stats.combat = parseInt(prompt('Combat (1-6):', '3')) || 3;
                stats.tech = parseInt(prompt('Tech (1-6):', '3')) || 3;
                stats.social = parseInt(prompt('Social (1-6):', '3')) || 3;
                stats.will = parseInt(prompt('Will (1-6):', '3')) || 3;
            } else {
                stats = {
                    skill: Math.floor(Math.random() * 4) + 2,
                    stealth: Math.floor(Math.random() * 4) + 2,
                    combat: Math.floor(Math.random() * 4) + 2,
                    tech: Math.floor(Math.random() * 4) + 2,
                    social: Math.floor(Math.random() * 4) + 2,
                    will: Math.floor(Math.random() * 4) + 2
                };
            }
            
            const trait = prompt('Special Trait:', 'No special trait - edit to customize');
            
            const newNPC = {
                id: Date.now(),
                name: name,
                title: title,
                ...stats,
                loyalty: Math.floor(Math.random() * 20) + 70,
                injury: 0,
                stress: 0,
                rank: 1,
                trait: trait || "No special trait - edit to customize",
                equipped_item: null,
                status: 'available'
            };
            
            gameState.npcs.push(newNPC);
            updateNPCList();
            calculateTechExpertise();
            updateAllResourceDisplays();
            logActivity(`New NPC recruited: ${name}`);
            showNotification(`${name} recruited!`);
        }

        function quickCreateNPC() {
            if (userRole !== 'gm') return;
            
            const names = ['Zara Voss', 'Marcus Reid', 'Nyx Shadow', 'Ajax Storm', 'Luna Cross', 'Kai Ember', 'Vera Steel', 'Rex Nova'];
            const titles = ['Operative', 'Specialist', 'Technician', 'Scout', 'Engineer', 'Analyst', 'Guardian', 'Infiltrator'];
            const traits = [
                'Quick Reflexes ‚Äî +1 to first action each mission',
                'Tech Savvy ‚Äî +2 Tech when working with equipment',
                'Stealthy ‚Äî Can avoid detection on failed stealth rolls',
                'Combat Veteran ‚Äî +1 Combat, reduces stress from violence',
                'Social Network ‚Äî Has contacts in various organizations',
                'Iron Will ‚Äî Immune to fear and intimidation effects'
            ];
            
            const name = names[Math.floor(Math.random() * names.length)];
            const title = titles[Math.floor(Math.random() * titles.length)];
            const trait = traits[Math.floor(Math.random() * traits.length)];
            
            const newNPC = {
                id: Date.now(),
                name: name,
                title: title,
                skill: Math.floor(Math.random() * 4) + 2,
                stealth: Math.floor(Math.random() * 4) + 2,
                combat: Math.floor(Math.random() * 4) + 2,
                tech: Math.floor(Math.random() * 4) + 2,
                social: Math.floor(Math.random() * 4) + 2,
                will: Math.floor(Math.random() * 4) + 2,
                loyalty: Math.floor(Math.random() * 20) + 70,
                injury: 0,
                stress: 0,
                rank: 1,
                trait: trait,
                equipped_item: null,
                status: 'available'
            };
            
            gameState.npcs.push(newNPC);
            updateNPCList();
            calculateTechExpertise();
            updateAllResourceDisplays();
            logActivity(`Quick recruit: ${name} (${title})`);
            showNotification(`${name} recruited! (Quick generation)`);
        }

        function removeSelectedNPC() {
            if (userRole !== 'gm') return;
            
            const selectedCheckboxes = document.querySelectorAll('.npc-select:checked');
            if (selectedCheckboxes.length === 0) {
                showNotification('No NPCs selected for removal', 'error');
                return;
            }
            
            if (!confirm(`Remove ${selectedCheckboxes.length} selected NPC(s)?`)) return;
            
            selectedCheckboxes.forEach(checkbox => {
                const npcId = parseInt(checkbox.dataset.npcId);
                const npcIndex = gameState.npcs.findIndex(npc => npc.id === npcId);
                if (npcIndex !== -1) {
                    const npc = gameState.npcs[npcIndex];
                    gameState.npcs.splice(npcIndex, 1);
                    logActivity(`NPC removed: ${npc.name}`);
                }
            });
            
            updateNPCList();
            calculateTechExpertise();
            updateAllResourceDisplays();
            showNotification(`${selectedCheckboxes.length} NPC(s) removed`);
        }

        // Player-side functions
        function updatePlayerCleaningOptions() {
            const container = document.getElementById('playerCleaningOptions');
            if (!container || userRole !== 'player') return;
            
            const damagedSections = Object.keys(gameState.sectionStates).filter(s => gameState.sectionStates[s] === 'damaged');
            const activeCleaning = Object.keys(gameState.cleaningTimers).length;
            
            if (activeCleaning >= 1) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-style: italic;">You can only clean one section at a time</div>';
                return;
            }
            
            if (damagedSections.length === 0) {
                container.innerHTML = '<div style="color: var(--green);">All sections are clean!</div>';
                return;
            }
            
            container.innerHTML = damagedSections.map(sectionId => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                    <div>
                        <div style="font-weight: 600;">${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Cleaning duration: 72 hours</div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="quick-btn" onclick="playerStartCleaning('${sectionId}', true)" style="font-size: 0.8rem;">Do Myself</button>
                        <button class="quick-btn" onclick="showNPCAssignmentModal('${sectionId}')" style="font-size: 0.8rem;">Assign NPCs</button>
                    </div>
                </div>
            `).join('');
        }

        function updatePlayerMissionOptions() {
            const container = document.getElementById('playerMissionOptions');
            if (!container || userRole !== 'player') return;
            
            const availableMissions = gameState.missions.filter(m => m.status === 'available');
            
            if (availableMissions.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-style: italic;">No missions available</div>';
                return;
            }
            
            container.innerHTML = availableMissions.map(mission => `
                <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 10px; margin-bottom: 8px;">
                    <div style="font-weight: 600; color: var(--gold); margin-bottom: 5px;">${mission.title}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">${mission.description}</div>
                    <div style="display: flex; gap: 5px;">
                        <button class="quick-btn" onclick="playerTakeMission(${mission.id}, true)" style="font-size: 0.8rem;">Do Myself</button>
                        <button class="quick-btn" onclick="showMissionNPCAssignment(${mission.id})" style="font-size: 0.8rem;">Assign NPCs</button>
                    </div>
                </div>
            `).join('');
        }

        function updateActiveOperations() {
            const container = document.getElementById('activeOperations');
            if (!container || userRole !== 'player') return;
            
            let operations = [];
            
            // Add cleaning operations
            Object.keys(gameState.cleaningTimers).forEach(sectionId => {
                const timer = gameState.cleaningTimers[sectionId];
                const remaining = getTimeRemaining(timer.startTime, 72);
                operations.push({
                    type: 'cleaning',
                    target: sectionId,
                    timeRemaining: remaining,
                    playerDoing: timer.playerDoing,
                    assignedNPCs: timer.assignedNPCs
                });
            });
            
            // Add mission operations
            Object.keys(gameState.missionAssignments).forEach(missionId => {
                const assignment = gameState.missionAssignments[missionId];
                const mission = gameState.missions.find(m => m.id == missionId);
                if (mission) {
                    operations.push({
                        type: 'mission',
                        target: mission.title,
                        playerDoing: assignment.playerDoing,
                        assignedNPCs: assignment.assignedNPCs
                    });
                }
            });
            
            if (operations.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-style: italic;">No active operations</div>';
                return;
            }
            
            container.innerHTML = operations.map(op => {
                const npcNames = op.assignedNPCs.map(id => {
                    const npc = gameState.npcs.find(n => n.id === id);
                    return npc ? npc.name : 'Unknown';
                }).join(', ');
                
                return `
                    <div style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 8px; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: var(--gold);">${op.type.charAt(0).toUpperCase() + op.type.slice(1)}: ${op.target}</div>
                        ${op.timeRemaining ? `<div style="font-size: 0.8rem; color: var(--cyan);">Time remaining: ${formatTimeRemaining(op.timeRemaining)}</div>` : ''}
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            ${op.playerDoing ? 'Player doing this' : `NPCs: ${npcNames}`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function playerStartCleaning(sectionId, playerDoing) {
            if (userRole !== 'player') return;
            startCleaning(sectionId, [], playerDoing);
        }

        function showNPCAssignmentModal(sectionId) {
            // Simplified NPC assignment - in a full implementation this would be a modal
            const availableNPCs = gameState.npcs.filter(npc => npc.status === 'available');
            if (availableNPCs.length === 0) {
                showNotification('No NPCs available for assignment', 'error');
                return;
            }
            
            const npcList = availableNPCs.map((npc, index) => `${index + 1}. ${npc.name} (${npc.title})`).join('\n');
            const selection = prompt(`Available NPCs:\n${npcList}\n\nEnter numbers separated by commas (e.g., 1,3):`);
            
            if (selection) {
                const indices = selection.split(',').map(s => parseInt(s.trim()) - 1).filter(i => i >= 0 && i < availableNPCs.length);
                const selectedNPCs = indices.map(i => availableNPCs[i].id);
                
                if (selectedNPCs.length > 0) {
                    startCleaning(sectionId, selectedNPCs, false);
                }
            }
        }

        // Enhanced Mission Functions
        function createEnhancedMission() {
            if (userRole !== 'gm') return;
            
            const title = document.getElementById('mission-title').value;
            const type = document.getElementById('mission-type').value;
            const description = document.getElementById('mission-description').value;
            const requirementsText = document.getElementById('mission-requirements').value;
            const rewardsText = document.getElementById('mission-rewards').value;
            
            if (!title || !description) {
                showNotification('Please fill in title and description', 'error');
                return;
            }
            
            // Parse requirements (e.g., "Stealth:5,Tech:3")
            const requirements = {};
            if (requirementsText) {
                requirementsText.split(',').forEach(req => {
                    const [stat, value] = req.trim().split(':');
                    if (stat && value) {
                        requirements[stat.toLowerCase()] = { min: parseInt(value) };
                    }
                });
            }
            
            const mission = {
                id: Date.now(),
                title,
                type,
                description,
                requirements,
                rewards: parseEnhancedRewards(rewardsText),
                status: 'available',
                duration: '2-3 days'
            };
            
            gameState.missions.push(mission);
            
            // Clear form
            document.getElementById('mission-title').value = '';
            document.getElementById('mission-description').value = '';
            document.getElementById('mission-requirements').value = '';
            document.getElementById('mission-rewards').value = '';
            
            logActivity(`New mission created: ${title}`);
            showNotification(`Mission "${title}" created!`);
        }

        function parseEnhancedRewards(rewardsText) {
            const rewards = { partial: {}, full: {}, perfect: {} };
            const parts = rewardsText.split(',');
            
            parts.forEach(part => {
                const match = part.trim().match(/(\d+)\s*(CP|CS|RS|DE)/i);
                if (match) {
                    const amount = parseInt(match[1]);
                    const type = match[2].toLowerCase();
                    const resourceMap = {
                        'cp': 'celestial-power',
                        'cs': 'celestial-silver', 
                        'rs': 'runic-shards',
                        'de': 'divine-essence'
                    };
                    if (resourceMap[type]) {
                        rewards.partial[resourceMap[type]] = Math.floor(amount * 0.5);
                        rewards.full[resourceMap[type]] = amount;
                        rewards.perfect[resourceMap[type]] = Math.floor(amount * 1.5);
                    }
                }
            });
            
            return rewards;
        }

        function deployNPCs() {
            if (userRole !== 'gm') return;
            showNotification('NPC deployment system coming soon!');
        }

        function resolveMissions() {
            if (userRole !== 'gm') return;
            showNotification('Mission resolution system coming soon!');
        }

        // Additional GM Functions for new systems
        function repairAllSections() {
            if (userRole !== 'gm') return;
            if (confirm('Emergency repair all sections? This will cost significant resources!')) {
                let totalCost = 0;
                Object.keys(gameState.sectionStates).forEach(sectionId => {
                    if (gameState.sectionStates[sectionId] === 'cleaned') {
                        const costs = gameState.sectionRepairCosts[sectionId];
                        totalCost += costs['celestial-power'] || 0;
                    }
                });
                
                if (gameState.resources['celestial-power'] >= totalCost) {
                    Object.keys(gameState.sectionStates).forEach(sectionId => {
                        if (gameState.sectionStates[sectionId] === 'cleaned') {
                            repairSection(sectionId);
                        }
                    });
                    showNotification('Emergency repairs completed!');
                } else {
                    showNotification('Insufficient Celestial Power for emergency repairs!', 'error');
                }
            }
        }

        function damageRandomSection() {
            if (userRole !== 'gm') return;
            const onlineSections = Object.keys(gameState.sectionStates).filter(s => gameState.sectionStates[s] === 'online');
            if (onlineSections.length > 0) {
                const randomSection = onlineSections[Math.floor(Math.random() * onlineSections.length)];
                gameState.sectionStates[randomSection] = 'damaged';
                updateSectionManagement();
                logActivity(`${randomSection} damaged by random event`);
                showNotification(`${randomSection} damaged by random event!`, 'error');
            } else {
                showNotification('No sections available to damage!');
            }
        }
        function completeMission() { 
            if (userRole !== 'gm') return;
            showNotification('Mission completion feature - select a mission first!'); 
        }
        
        function deleteMission() { 
            if (userRole !== 'gm') return;
            showNotification('Mission deletion feature - select a mission first!'); 
        }
        
        function kickPlayer() { 
            if (userRole !== 'gm') return;
            showNotification('Player kick feature - select a player first!'); 
        }
        
        function broadcastMessage() { 
            if (userRole !== 'gm') return;
            const message = prompt('Send message to all players:');
            if (message) {
                logActivity(`GM broadcast: ${message}`);
                showNotification('Message sent to all players!');
            }
        }
        
        function saveGameState() { 
            if (userRole !== 'gm') return;
            localStorage.setItem('bastion-gm-backup', JSON.stringify(gameState));
            showNotification('Game state saved!'); 
        }
        
        function loadGameState() { 
            if (userRole !== 'gm') return;
            const backup = localStorage.getItem('bastion-gm-backup');
            if (backup) {
                gameState = JSON.parse(backup);
                updateAllResourceDisplays();
                updateGMResourceInputs();
                showNotification('Game state loaded!');
                window.location.reload(); // Refresh to show all updates
            } else {
                showNotification('No backup found!', 'error');
            }
        }
        
        function resetCampaign() { 
            if (userRole !== 'gm') return;
            if (confirm('Are you sure you want to reset the entire campaign? This cannot be undone!')) {
                gameState = {
                    resources: {
                        'celestial-power': 0,
                        'celestial-silver': 0,
                        'runic-shards': 0,
                        'divine-essence': 0,
                        'technical-expertise': 0
                    },
                    upgrades: {
                        luminarium: { research: [], offensive: [], defensive: [] },
                        sanctum: { research: [], offensive: [], defensive: [] },
                        wards: { research: [], offensive: [], defensive: [] },
                        throne: { research: [], offensive: [], defensive: [] },
                        gateway: { research: [], offensive: [], defensive: [] },
                        fountain: { research: [], offensive: [], defensive: [] }
                    },
                    missions: [],
                    players: ['Alice', 'Bob', 'Charlie', 'Diana'],
                    activity: []
                };
                updateAllResourceDisplays();
                updateGMResourceInputs();
                showNotification('Campaign reset!', 'error');
                window.location.reload();
            }
        }
        
        function exportData() { 
            if (userRole !== 'gm') return;
            const dataStr = JSON.stringify(gameState, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'bastion-campaign-data.json';
            link.click();
            showNotification('Campaign data exported!');
        }

        // Update all upgrade states when resources change
        function updateAllUpgradeStates() {
            Object.keys(sections).forEach(sectionId => {
                Object.keys(sections[sectionId].paths).forEach(pathType => {
                    sections[sectionId].paths[pathType].forEach((upgrade, index) => {
                        const upgradeElement = document.getElementById(`${sectionId}-${pathType}-${index}`);
                        if (upgradeElement) {
                            const isCompleted = gameState.upgrades[sectionId][pathType].includes(index);
                            const canAfford = canAffordUpgrade(upgrade.cost);
                            
                            const statusElement = upgradeElement.querySelector('.upgrade-status');
                            const buttonElement = upgradeElement.querySelector('.purchase-btn');
                            
                            if (isCompleted) {
                                statusElement.textContent = 'Completed';
                                statusElement.className = 'upgrade-status status-completed';
                                if (buttonElement) buttonElement.style.display = 'none';
                            } else if (canAfford) {
                                statusElement.textContent = 'Available';
                                statusElement.className = 'upgrade-status status-available';
                                if (buttonElement) {
                                    buttonElement.disabled = false;
                                    buttonElement.style.display = 'inline-block';
                                }
                            } else {
                                statusElement.textContent = 'Locked';
                                statusElement.className = 'upgrade-status status-locked';
                                if (buttonElement) {
                                    buttonElement.disabled = true;
                                    buttonElement.style.display = 'inline-block';
                                }
                            }
                        }
                    });
                });
                updateSectionProgress(sectionId);
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-focus username field
            document.getElementById('username').focus();
        });
    </script>
</body>
</html>
