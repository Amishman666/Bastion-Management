function resetSection() {
            if (currentRole !== 'gm') return;
            alert('Section reset functionality - coming soon');
        }

        function triggerEvent() {
            if (currentRole !== 'gm') return;
            alert('Event trigger functionality - coming soon');
        }

        function exportData() {
            if (currentRole !== 'gm') return;
            exportGameData();
        }

        function importGameData() {
            if (currentRole !== 'gm') return;
            alert('Import functionality - coming soon');
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Bastion - Celestial Fortress Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables */
        :root {
            --primary-bg: #0a0e1a;
            --secondary-bg: #1a1f2e;
            --accent-bg: #2a3441;
            --gold: #ffd700;
            --gold-dark: #b8860b;
            --cyan: #00d4ff;
            --red: #ff3366;
            --green: #00ff88;
            --purple: #b266ff;
            --text-primary: #ffffff;
            --text-secondary: #b8c5d1;
            --border: rgba(255, 215, 0, 0.3);
            --glow: 0 0 20px rgba(255, 215, 0, 0.3);
            --font-primary: 'Exo 2', sans-serif;
            --font-display: 'Orbitron', monospace;
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: linear-gradient(135deg, var(--primary-bg) 0%, #0f1419 50%, var(--primary-bg) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(178, 102, 255, 0.1) 0%, transparent 50%);
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--glow);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-title {
            font-family: var(--font-display);
            font-size: 2rem;
            color: var(--gold);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, var(--gold), var(--gold-dark));
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .login-help {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Main App Container */
        .app-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Top Navigation */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 30px;
            box-shadow: var(--glow);
        }

        .nav-title {
            font-family: var(--font-display);
            font-size: 1.8rem;
            color: var(--gold);
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-role {
            padding: 6px 12px;
            background: var(--cyan);
            color: #000;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        .user-role.gm {
            background: var(--red);
            color: white;
        }

        .logout-btn {
            padding: 8px 16px;
            background: var(--red);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Tab System */
        .tab-nav {
            display: flex;
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            gap: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-btn.active {
            background: var(--gold);
            color: #000;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Status Bar */
        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status-item {
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow);
        }

        .status-item .icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }

        .status-item .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .status-item .value {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--gold);
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--glow);
            height: fit-content;
        }

        .sidebar h2 {
            font-family: var(--font-display);
            color: var(--gold);
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        /* Resource Management */
        .resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .resource-item:hover {
            background: rgba(255, 215, 0, 0.05);
            border-radius: 8px;
            padding-left: 10px;
            padding-right: 10px;
        }

        .resource-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .resource-icon {
            font-size: 1.2rem;
            width: 25px;
        }

        .resource-name {
            font-weight: 500;
        }

        .resource-amount {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .resource-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .resource-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            color: white;
            width: 80px;
            text-align: center;
            margin-top: 4px;
        }

        .resource-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* GM Controls */
        .gm-controls {
            background: linear-gradient(135deg, var(--red), #8B0000);
            border: 1px solid rgba(255, 51, 102, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .gm-controls h3 {
            color: white;
            margin-bottom: 15px;
            font-family: var(--font-display);
        }

        .gm-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .gm-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Mission Management */
        .mission-management {
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .mission-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mission-form .form-group {
            margin-bottom: 15px;
        }

        .mission-form .form-group.full-width {
            grid-column: 1 / -1;
        }

        .mission-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .mission-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        .mission-title {
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 5px;
        }

        .mission-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .mission-rewards {
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--green);
        }

        .mission-stats {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 0.8rem;
        }

        .stat-requirement {
            background: rgba(0, 212, 255, 0.2);
            color: var(--cyan);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--cyan);
        }

        .mission-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: var(--cyan);
            color: #000;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .action-btn.delete {
            background: var(--red);
            color: white;
        }

        /* NPC Styles */
        .npc-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            display: flex;
            gap: 20px;
        }

        .npc-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 2px solid var(--border);
            overflow: hidden;
            flex-shrink: 0;
        }

        .npc-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .npc-avatar.no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--text-secondary);
        }

        .npc-info {
            flex: 1;
        }

        .npc-name {
            font-weight: 600;
            color: var(--gold);
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .npc-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .npc-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .npc-stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
        }

        .npc-stat-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin-bottom: 2px;
        }

        .npc-stat-value {
            font-weight: 600;
            color: var(--cyan);
        }

        /* Section status and action styles */
        .section-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .status-indicator {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-damaged {
            background: var(--red);
            color: white;
        }

        .status-cleaning {
            background: var(--gold);
            color: #000;
        }

        .status-clean {
            background: var(--cyan);
            color: #000;
        }

        .status-repairing {
            background: var(--purple);
            color: white;
        }

        .status-operational {
            background: var(--green);
            color: #000;
        }

        .section-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .section-btn {
            background: linear-gradient(45deg, var(--cyan), #0099cc);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .section-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }

        .section-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .section-timer {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .power-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .power-draw {
            color: var(--red);
        }

        .power-generation {
            color: var(--green);
        }

        /* Mission assignment styles */
        .mission-assignment {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .assignment-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .assign-btn {
            background: var(--green);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .assign-btn:hover {
            background: var(--cyan);
        }

        .assign-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }

        .npc-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .npc-option {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .npc-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--cyan);
        }

        .npc-option.selected {
            background: rgba(0, 212, 255, 0.2);
            border-color: var(--cyan);
        }

        .npc-option.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .mission-timer {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--gold);
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--gold);
        }

        /* Sections Grid */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .section-card {
            background: linear-gradient(135deg, var(--secondary-bg), var(--accent-bg));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--glow);
            transition: all 0.3s ease;
        }

        .section-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255, 215, 0, 0.2), var(--glow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-family: var(--font-display);
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--gold);
        }

        .section-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--cyan));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Path Styles */
        .paths-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .path {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .path-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .path-header:hover {
            background: rgba(255, 215, 0, 0.05);
        }

        .path-name {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .path.research .path-name { color: var(--cyan); }
        .path.offensive .path-name { color: var(--red); }
        .path.defensive .path-name { color: var(--green); }

        .path-toggle {
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: transform 0.3s ease;
        }

        .path.expanded .path-toggle {
            transform: rotate(180deg);
        }

        .upgrades-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .path.expanded .upgrades-list {
            max-height: 1000px;
        }

        .upgrade-item {
            background: rgba(255, 255, 255, 0.02);
            margin: 0 15px 15px 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 18px;
            transition: all 0.3s ease;
        }

        .upgrade-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .upgrade-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.05rem;
        }

        .upgrade-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-available {
            background: var(--green);
            color: #000;
        }

        .status-locked {
            background: var(--red);
            color: white;
        }

        .status-completed {
            background: var(--gold);
            color: #000;
        }

        .upgrade-description {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .upgrade-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upgrade-cost {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }

        .cost-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
        }

        .purchase-btn {
            background: linear-gradient(45deg, var(--gold), var(--gold-dark));
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .purchase-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .purchase-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .sections-grid {
                grid-template-columns: 1fr;
            }
            
            .mission-form {
                grid-template-columns: 1fr;
            }
            
            .npc-item {
                flex-direction: column;
                text-align: center;
            }
            
            .npc-avatar {
                align-self: center;
            }
            
            .npc-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tab-nav {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                flex: 1 1 auto;
                min-width: 120px;
            }
        }

        /* Hide elements based on user role */
        .player-only {
            display: block;
        }

        .gm-only {
            display: none;
        }

        .app-container.gm-mode .player-only {
            display: none;
        }

        .app-container.gm-mode .gm-only {
            display: block;
        }
    </style>
</head>
<body>
    <div class="background-animation"></div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1 class="login-title"><i class="fas fa-fortress"></i> THE BASTION</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Access Code</label>
                    <input type="password" class="form-input" id="password" required>
                </div>
                <button type="submit" class="login-btn">Access Bastion</button>
            </form>
            <div class="login-help">
                <strong>Player Access:</strong><br>
                Username: jon<br>
                Password: bastion2024
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="app-container">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-title">
                <i class="fas fa-fortress"></i> The Bastion
            </div>
            <div class="nav-user">
                <span class="user-role" id="userRole">Player</span>
                <span id="currentUser">User</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="tab-btn player-only" onclick="switchTab('missions')">
                <i class="fas fa-scroll"></i> Mission Board
            </button>
            <button class="tab-btn gm-only" onclick="switchTab('missions')">
                <i class="fas fa-tasks"></i> Mission Control
            </button>
            <button class="tab-btn gm-only" onclick="switchTab('npcs')">
                <i class="fas fa-users"></i> NPC Management
            </button>
            <button class="tab-btn gm-only" onclick="switchTab('admin')">
                <i class="fas fa-cogs"></i> Administration
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-item">
                    <span class="icon">üü¢</span>
                    <div class="label">System Status</div>
                    <div class="value">ONLINE</div>
                </div>
                <div class="status-item">
                    <span class="icon">‚ö°</span>
                    <div class="label">Power Level</div>
                    <div class="value" id="power-level">85%</div>
                </div>
                <div class="status-item">
                    <span class="icon">üõ°Ô∏è</span>
                    <div class="label">Defenses</div>
                    <div class="value">ACTIVE</div>
                </div>
                <div class="status-item">
                    <span class="icon">üë•</span>
                    <div class="label">Players</div>
                    <div class="value">4</div>
                </div>
            </div>

            <!-- GM Controls (only visible to GM) -->
            <div class="gm-controls gm-only">
                <h3><i class="fas fa-crown"></i> GM Quick Actions</h3>
                <button class="gm-btn" onclick="addResources()">
                    <i class="fas fa-plus"></i> Add Resources
                </button>
                <button class="gm-btn" onclick="resetSection()">
                    <i class="fas fa-undo"></i> Reset Section
                </button>
                <button class="gm-btn" onclick="triggerEvent()">
                    <i class="fas fa-bolt"></i> Trigger Event
                </button>
                <button class="gm-btn" onclick="exportData()">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>

            <!-- Main Grid -->
            <div class="main-grid">
                <!-- Resource Sidebar -->
                <div class="sidebar">
                    <h2><i class="fas fa-coins"></i> Resources</h2>
                    <div class="resource-item">
                        <div class="resource-info">
                            <span class="resource-icon">‚ö°</span>
                            <span class="resource-name">Celestial Power</span>
                        </div>
                        <div class="resource-amount">
                            <span class="resource-value" id="celestial-power">1250</span>
                            <input type="number" class="resource-input gm-only" id="celestial-power-input" value="1250" onchange="updateResource('celestial-power', this.value)">
                        </div>
                    </div>
                    <div class="resource-item">
                        <div class="resource-info">
                            <span class="resource-icon">ü•à</span>
                            <span class="resource-name">Celestial Silver</span>
                        </div>
                        <div class="resource-amount">
                            <span class="resource-value" id="celestial-silver">85</span>
                            <input type="number" class="resource-input gm-only" id="celestial-silver-input" value="85" onchange="updateResource('celestial-silver', this.value)">
                        </div>
                    </div>
                    <div class="resource-item">
                        <div class="resource-info">
                            <span class="resource-icon">üíé</span>
                            <span class="resource-name">Runic Shards</span>
                        </div>
                        <div class="resource-amount">
                            <span class="resource-value" id="runic-shards">12</span>
                            <input type="number" class="resource-input gm-only" id="runic-shards-input" value="12" onchange="updateResource('runic-shards', this.value)">
                        </div>
                    </div>
                    <div class="resource-item">
                        <div class="resource-info">
                            <span class="resource-icon">‚ú®</span>
                            <span class="resource-name">Divine Essence</span>
                        </div>
                        <div class="resource-amount">
                            <span class="resource-value" id="divine-essence">3</span>
                            <input type="number" class="resource-input gm-only" id="divine-essence-input" value="3" onchange="updateResource('divine-essence', this.value)">
                        </div>
                    </div>
                    <div class="resource-item">
                        <div class="resource-info">
                            <span class="resource-icon">üî¨</span>
                            <span class="resource-name">Tech Expertise</span>
                        </div>
                        <div class="resource-amount">
                            <span class="resource-value" id="technical-expertise">5</span>
                            <input type="number" class="resource-input gm-only" id="technical-expertise-input" value="5" onchange="updateResource('technical-expertise', this.value)">
                        </div>
                    </div>
                </div>

                <!-- Sections Grid -->
                <div class="sections-grid" id="sections-container">
                    <!-- Sections will be dynamically generated -->
                </div>
            </div>
        </div>

        <!-- Mission Control Tab (GM Only) -->
        <div id="missionsTab" class="tab-content">
            <!-- GM Mission Control -->
            <div class="gm-only">
                <div class="mission-management">
                    <h2><i class="fas fa-tasks"></i> Mission Control</h2>
                    
                    <!-- Mission Creation Form -->
                    <div class="mission-form">
                        <div class="form-group">
                            <label class="form-label">Mission Title</label>
                            <input type="text" class="form-input" id="missionTitle" placeholder="Enter mission title">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Difficulty</label>
                            <select class="form-input" id="missionDifficulty">
                                <option value="easy">Easy</option>
                                <option value="medium">Medium</option>
                                <option value="hard">Hard</option>
                                <option value="legendary">Legendary</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Mission Description</label>
                            <textarea class="form-input" id="missionDescription" rows="3" placeholder="Describe the mission"></textarea>
                        </div>
                        
                        <!-- Stat Requirements -->
                        <div class="form-group full-width">
                            <h4 style="color: var(--gold); margin-bottom: 10px;">Stat Requirements (Optional)</h4>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Skill Requirement</label>
                            <input type="number" class="form-input" id="missionSkill" value="0" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Stealth Requirement</label>
                            <input type="number" class="form-input" id="missionStealth" value="0" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Combat Requirement</label>
                            <input type="number" class="form-input" id="missionCombat" value="0" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tech Requirement</label>
                            <input type="number" class="form-input" id="missionTech" value="0" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Social Requirement</label>
                            <input type="number" class="form-input" id="missionSocial" value="0" min="0" max="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Will Requirement</label>
                            <input type="number" class="form-input" id="missionWill" value="0" min="0" max="10">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Reward Type</label>
                            <select class="form-input" id="rewardType">
                                <option value="celestial-power">Celestial Power</option>
                                <option value="celestial-silver">Celestial Silver</option>
                                <option value="runic-shards">Runic Shards</option>
                                <option value="divine-essence">Divine Essence</option>
                                <option value="technical-expertise">Tech Expertise</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reward Amount</label>
                            <input type="number" class="form-input" id="rewardAmount" value="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mission Duration (hours)</label>
                            <input type="number" class="form-input" id="missionDuration" value="24" min="1">
                        </div>
                        <div class="form-group full-width">
                            <button class="login-btn" onclick="createMission()">
                                <i class="fas fa-plus"></i> Create Mission
                            </button>
                        </div>
                    </div>

                    <!-- Mission List -->
                    <div class="mission-list" id="missionList">
                        <!-- Missions will be dynamically generated -->
                    </div>
                </div>
            </div>
            
            <!-- Player Mission Board -->
            <div class="player-only">
                <div class="mission-management">
                    <h2><i class="fas fa-scroll"></i> Mission Board</h2>
                    <div class="mission-list" id="playerMissionList">
                        <!-- Player missions will be dynamically generated -->
                    </div>
                </div>
            </div>
        </div>

        <!-- NPC Management Tab (GM Only) -->
        <div id="npcsTab" class="tab-content gm-only">
            <div class="mission-management">
                <h2><i class="fas fa-users"></i> NPC Management</h2>
                
                <!-- NPC Creation Form -->
                <div class="mission-form">
                    <div class="form-group">
                        <label class="form-label">NPC Name</label>
                        <input type="text" class="form-input" id="npcName" placeholder="Enter NPC name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Image URL</label>
                        <input type="url" class="form-input" id="npcImage" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Skill</label>
                        <input type="number" class="form-input" id="npcSkill" value="1" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stealth</label>
                        <input type="number" class="form-input" id="npcStealth" value="1" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Combat</label>
                        <input type="number" class="form-input" id="npcCombat" value="1" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tech</label>
                        <input type="number" class="form-input" id="npcTech" value="1" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Social</label>
                        <input type="number" class="form-input" id="npcSocial" value="1" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Will</label>
                        <input type="number" class="form-input" id="npcWill" value="1" min="1" max="10">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="npcDescription" rows="3" placeholder="Describe the NPC's background and abilities"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <button class="login-btn" onclick="createNPC()">
                            <i class="fas fa-plus"></i> Create NPC
                        </button>
                    </div>
                </div>

                <!-- NPC List -->
                <div class="mission-list" id="npcList">
                    <!-- NPCs will be dynamically generated -->
                </div>
            </div>
        </div>

        <!-- Administration Tab (GM Only) -->
        <div id="adminTab" class="tab-content gm-only">
            <h2><i class="fas fa-cogs"></i> System Administration</h2>
            <div class="gm-controls">
                <h3>Data Management</h3>
                <button class="gm-btn" onclick="exportGameData()">
                    <i class="fas fa-download"></i> Export Game Data
                </button>
                <button class="gm-btn" onclick="importGameData()">
                    <i class="fas fa-upload"></i> Import Game Data
                </button>
                <button class="gm-btn" onclick="resetGame()">
                    <i class="fas fa-exclamation-triangle"></i> Reset Game
                </button>
                
                <h3>Resource Controls</h3>
                <button class="gm-btn" onclick="maxAllResources()">
                    <i class="fas fa-arrow-up"></i> Max All Resources
                </button>
                <button class="gm-btn" onclick="zeroAllResources()">
                    <i class="fas fa-arrow-down"></i> Zero All Resources
                </button>
                
                <h3>Section Controls</h3>
                <button class="gm-btn" onclick="unlockAllUpgrades()">
                    <i class="fas fa-unlock"></i> Unlock All Upgrades
                </button>
                <button class="gm-btn" onclick="resetAllUpgrades()">
                    <i class="fas fa-lock"></i> Reset All Upgrades
                </button>
            </div>
        </div>
    </div>

    <script>
        // Authentication and User Management
        const users = {
            'jon': { password: 'bastion2024', role: 'player' },
            'gm': { password: 'gmbastion2024', role: 'gm' }
        };

        let currentUser = null;
        let currentRole = null;

        // Game State
        const gameState = {
            resources: {
                'celestial-power': 1250,
                'celestial-silver': 85,
                'runic-shards': 12,
                'divine-essence': 3,
                'technical-expertise': 5
            },
            upgrades: {
                luminarium: { research: [], offensive: [], defensive: [] },
                sanctum: { research: [], offensive: [], defensive: [] },
                wards: { research: [], offensive: [], defensive: [] },
                throne: { research: [], offensive: [], defensive: [] },
                gateway: { research: [], offensive: [], defensive: [] },
                fountain: { research: [], offensive: [], defensive: [] }
            },
            missions: [
                {
                    id: 1,
                    title: "Angel Contact Mission",
                    description: "Establish diplomatic contact with celestial beings",
                    difficulty: "medium",
                    requirements: { skill: 3, stealth: 0, combat: 0, tech: 0, social: 4, will: 2 },
                    reward: { type: "divine-essence", amount: 1 },
                    status: "completed"
                },
                {
                    id: 2,
                    title: "Void Scan Research",
                    description: "Scan astral debris fields for valuable resources",
                    difficulty: "easy",
                    requirements: { skill: 2, stealth: 0, combat: 0, tech: 3, social: 0, will: 1 },
                    reward: { type: "runic-shards", amount: 3 },
                    status: "completed"
                }
            ],
            npcs: [
                {
                    id: 1,
                    name: "Seraph Valdris",
                    description: "A former celestial scout with unmatched diplomatic skills and deep knowledge of divine protocols.",
                    image: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face",
                    stats: { skill: 6, stealth: 3, combat: 4, tech: 2, social: 8, will: 7 },
                    status: "available"
                },
                {
                    id: 2,
                    name: "Raven Blackthorne",
                    description: "Master infiltrator and information broker. Moves through shadows like they don't exist.",
                    image: "https://images.unsplash.com/photo-1494790108755-2616b612b786?w=150&h=150&fit=crop&crop=face",
                    stats: { skill: 5, stealth: 9, combat: 6, tech: 4, social: 3, will: 5 },
                    status: "available"
                }
            ]
        };

        // Section Definitions
        const sections = {
            luminarium: {
                title: "üèõÔ∏è Luminarium",
                description: "Main Power Generator",
                paths: {
                    research: [
                        { name: "Pulse Harmonization", description: "Increases efficiency of all other sections by 10% when fully operational.", cost: { 'celestial-power': 100, 'technical-expertise': 2 } },
                        { name: "Celestial Mapping", description: "Tracks divine energy sources throughout the cosmos.", cost: { 'celestial-power': 150, 'runic-shards': 3 } },
                        { name: "Grace Recycling", description: "Recovers spent grace for reuse in critical systems.", cost: { 'celestial-power': 200, 'divine-essence': 1 } }
                    ],
                    offensive: [
                        { name: "Radiant Overcharge", description: "Release a radiant pulse that deals light damage to all enemies within the Bastion.", cost: { 'celestial-power': 120, 'celestial-silver': 50 } },
                        { name: "Focused Beam", description: "Channel concentrated energy into a devastating attack against a single target.", cost: { 'celestial-power': 180, 'runic-shards': 4 } },
                        { name: "Grace Storm", description: "Create a field of wild grace energy that disrupts magical effects.", cost: { 'celestial-power': 250, 'divine-essence': 2 } }
                    ],
                    defensive: [
                        { name: "Failsafe Core", description: "Prevents total Bastion failure once per major event.", cost: { 'celestial-power': 200, 'technical-expertise': 3 } },
                        { name: "Adaptive Shielding", description: "Automatically adjusts defenses based on incoming threats.", cost: { 'celestial-power': 300, 'runic-shards': 5 } },
                        { name: "Dimensional Anchor", description: "Prevents forced translocation of the Bastion.", cost: { 'celestial-power': 400, 'divine-essence': 3 } }
                    ]
                }
            },
            sanctum: {
                title: "‚õ™ Sanctum",
                description: "Purification & Spiritual Focus",
                paths: {
                    research: [
                        { name: "Soul Resonance Mapping", description: "Grants insight into corrupted items or beings.", cost: { 'celestial-power': 80, 'divine-essence': 1 } },
                        { name: "Divine Communion", description: "Establish temporary communication with higher divine powers.", cost: { 'celestial-power': 150, 'divine-essence': 2 } },
                        { name: "Ethereal Perception", description: "Detect spiritual anomalies across dimensional boundaries.", cost: { 'celestial-power': 200, 'runic-shards': 3 } }
                    ],
                    offensive: [
                        { name: "Judgment Flare", description: "Empower allies to deal radiant damage when fighting corrupted foes.", cost: { 'celestial-power': 100, 'celestial-silver': 40 } },
                        { name: "Banishment Wave", description: "Force extraplanar entities back to their native dimensions.", cost: { 'celestial-power': 180, 'divine-essence': 2 } },
                        { name: "Purifying Flame", description: "Create weapons of pure spiritual energy.", cost: { 'celestial-power': 250, 'divine-essence': 3 } }
                    ],
                    defensive: [
                        { name: "Sacred Veil", description: "Aura around the Sanctum slowly purifies corruption in adjacent areas.", cost: { 'celestial-power': 120, 'runic-shards': 2 } },
                        { name: "Spiritual Barrier", description: "Block attempts at spiritual invasion or possession.", cost: { 'celestial-power': 200, 'divine-essence': 2 } },
                        { name: "Blessing of Protection", description: "Grant allies temporary immunity to corruption.", cost: { 'celestial-power': 300, 'divine-essence': 4 } }
                    ]
                }
            },
            wards: {
                title: "üõ°Ô∏è Wards",
                description: "Defensive Matrix",
                paths: {
                    research: [
                        { name: "Sigil Scripting", description: "Inscribe temporary protective runes before dangerous missions.", cost: { 'celestial-power': 90, 'technical-expertise': 2 } },
                        { name: "Breach Analysis", description: "When wards are compromised, gain perfect understanding of the method used.", cost: { 'celestial-power': 160, 'runic-shards': 3 } },
                        { name: "Reactive Mathematics", description: "Defensive formulas that adapt to new threats.", cost: { 'celestial-power': 220, 'technical-expertise': 4 } }
                    ],
                    offensive: [
                        { name: "Heaven's Volley", description: "Install celestial cannon arrays on the Bastion.", cost: { 'celestial-power': 150, 'celestial-silver': 60 } },
                        { name: "Counter-Sigils", description: "When defensive wards are struck, they reflect a portion of the attack back.", cost: { 'celestial-power': 200, 'runic-shards': 4 } },
                        { name: "Binding Protocols", description: "Create temporary fields that restrict movement of hostile entities.", cost: { 'celestial-power': 280, 'divine-essence': 2 } }
                    ],
                    defensive: [
                        { name: "Layered Shielding", description: "Enhances physical and magical ward structures.", cost: { 'celestial-power': 140, 'technical-expertise': 3 } },
                        { name: "Phasing Barriers", description: "Defenses exist partially out of phase.", cost: { 'celestial-power': 220, 'runic-shards': 5 } },
                        { name: "Bastion Memory", description: "The structure 'remembers' previous attacks.", cost: { 'celestial-power': 350, 'divine-essence': 3 } }
                    ]
                }
            },
            throne: {
                title: "üëë Throne Room",
                description: "Command Center",
                paths: {
                    research: [
                        { name: "Battle Archives", description: "Gain tactical insights post-battle.", cost: { 'celestial-power': 100, 'technical-expertise': 2 } },
                        { name: "Strategic Modeling", description: "Create magical simulations to test tactics.", cost: { 'celestial-power': 180, 'runic-shards': 3 } },
                        { name: "Command Linguistics", description: "Enhanced communication with allies across vast distances.", cost: { 'celestial-power': 240, 'divine-essence': 2 } }
                    ],
                    offensive: [
                        { name: "Battle Synchrony", description: "Designate coordinated missions with improved success rates.", cost: { 'celestial-power': 120, 'celestial-silver': 50 } },
                        { name: "Command Authority", description: "Voice carries supernatural weight, causing enemies to hesitate.", cost: { 'celestial-power': 200, 'divine-essence': 2 } },
                        { name: "Tactical Inspiration", description: "Grant allies unexpected insights during critical moments.", cost: { 'celestial-power': 300, 'divine-essence': 3 } }
                    ],
                    defensive: [
                        { name: "Iron Mandate", description: "Enemies attempting to sabotage command face higher resistance.", cost: { 'celestial-power': 110, 'technical-expertise': 2 } },
                        { name: "Protected Awareness", description: "Command staff cannot be magically scried upon.", cost: { 'celestial-power': 190, 'runic-shards': 4 } },
                        { name: "Contingency Protocols", description: "Automated systems maintain basic functions if command is compromised.", cost: { 'celestial-power': 280, 'technical-expertise': 5 } }
                    ]
                }
            },
            gateway: {
                title: "üåÄ Gateway",
                description: "Teleportation Hub",
                paths: {
                    research: [
                        { name: "Harmonic Coordinates", description: "Unlock hidden realms or rare mission sites.", cost: { 'celestial-power': 130, 'runic-shards': 3 } },
                        { name: "Sympathetic Mapping", description: "Return to any visited location with perfect accuracy.", cost: { 'celestial-power': 200, 'technical-expertise': 3 } },
                        { name: "Beacon Understanding", description: "Analyze and replicate transportation methods of other beings.", cost: { 'celestial-power': 270, 'divine-essence': 2 } }
                    ],
                    offensive: [
                        { name: "Tactical Insertion", description: "Deploy teams directly into hostile locations.", cost: { 'celestial-power': 160, 'celestial-silver': 70 } },
                        { name: "Portal Strike", description: "Open momentary gateways to launch attacks from unexpected angles.", cost: { 'celestial-power': 230, 'runic-shards': 4 } },
                        { name: "Dimensional Shear", description: "Create unstable planar intersections that damage creatures.", cost: { 'celestial-power': 320, 'divine-essence': 3 } }
                    ],
                    defensive: [
                        { name: "Interdiction Array", description: "Nullifies teleportation-based infiltration attempts.", cost: { 'celestial-power': 150, 'technical-expertise': 3 } },
                        { name: "Escape Protocols", description: "Automatically evacuates critical personnel in emergencies.", cost: { 'celestial-power': 220, 'runic-shards': 5 } },
                        { name: "Planar Anchoring", description: "Stabilizes local reality, preventing dimensional manipulation.", cost: { 'celestial-power': 350, 'divine-essence': 4 } }
                    ]
                }
            },
            fountain: {
                title: "‚õ≤ Fountain of Grace",
                description: "Healing Center",
                paths: {
                    research: [
                        { name: "Graceflow Optimization", description: "Increases passive generation of celestial silver.", cost: { 'celestial-power': 110, 'technical-expertise': 2 } },
                        { name: "Essence Analysis", description: "Identify the nature and source of injuries with perfect accuracy.", cost: { 'celestial-power': 170, 'divine-essence': 1 } },
                        { name: "Resurrection Protocols", description: "Establish foundation for potential revival of fallen allies.", cost: { 'celestial-power': 300, 'divine-essence': 4 } }
                    ],
                    offensive: [
                        { name: "Blessing Surge", description: "Store divine interventions for use in dire situations.", cost: { 'celestial-power': 140, 'celestial-silver': 60 } },
                        { name: "Purifying Cascade", description: "Transform fountain energies into damaging waves.", cost: { 'celestial-power': 210, 'divine-essence': 2 } },
                        { name: "Lifeforce Manipulation", description: "Temporarily enhance allies' physical capabilities.", cost: { 'celestial-power': 290, 'divine-essence': 3 } }
                    ],
                    defensive: [
                        { name: "Aegis Misting", description: "Emergency regenerative mist healing allies in adjacent sections.", cost: { 'celestial-power': 120, 'runic-shards': 3 } },
                        { name: "Stasis Field", description: "Preserve critically wounded in suspended animation.", cost: { 'celestial-power': 200, 'technical-expertise': 4 } },
                        { name: "Vitality Shield", description: "Convert incoming damage to healing energy.", cost: { 'celestial-power': 320, 'divine-essence': 4 } }
                    ]
                }
            }
        };

        const resourceIcons = {
            'celestial-power': '‚ö°',
            'celestial-silver': 'ü•à',
            'runic-shards': 'üíé',
            'divine-essence': '‚ú®',
            'technical-expertise': 'üî¨'
        };

        // Authentication
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                currentRole = users[username].role;
                showMainApp();
            } else {
                alert('Invalid credentials!');
            }
        });

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUser').textContent = currentUser;
            document.getElementById('userRole').textContent = currentRole.toUpperCase();
            document.getElementById('userRole').className = `user-role ${currentRole}`;
            
            if (currentRole === 'gm') {
                document.getElementById('mainApp').classList.add('gm-mode');
            }
            
            loadGameState();
            initializeDashboard();
            renderMissions();
            renderNPCs();
            renderPlayerMissions();
            
            // Start timer system
            setInterval(updateTimers, 60000); // Update every minute
            updateTimers(); // Initial update
        }

        function logout() {
            currentUser = null;
            currentRole = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('mainApp').classList.remove('gm-mode');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Tab System
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Resource Management
        function updateResource(resourceId, value) {
            // Only allow GMs to update resources
            if (currentRole !== 'gm') {
                console.log('Access denied: Only GMs can modify resources');
                return;
            }
            
            gameState.resources[resourceId] = parseInt(value) || 0;
            document.getElementById(resourceId).textContent = gameState.resources[resourceId];
            updateAllUpgradeStates();
            updatePowerLevel();
            saveGameState();
        }

        function updatePowerLevel() {
            const totalPower = gameState.resources['celestial-power'];
            const powerPercent = Math.min(100, Math.max(0, (totalPower / 2000) * 100));
            document.getElementById('power-level').textContent = Math.round(powerPercent) + '%';
        }

        // Upgrade System
        function canAffordUpgrade(costs) {
            for (let resource in costs) {
                if (gameState.resources[resource] < costs[resource]) {
                    return false;
                }
            }
            return true;
        }

        // Override upgrade purchasing to require operational sections
        function purchaseUpgrade(sectionId, pathType, upgradeIndex) {
            const sectionState = gameState.sectionStates[sectionId];
            
            // Check if section is operational
            if (sectionState.status !== 'operational') {
                alert('Section must be cleaned and repaired before upgrades can be purchased!');
                return;
            }
            
            const upgrade = sections[sectionId].paths[pathType][upgradeIndex];
            
            if (canAffordUpgrade(upgrade.cost) && !gameState.upgrades[sectionId][pathType].includes(upgradeIndex)) {
                // Deduct costs
                for (let resource in upgrade.cost) {
                    gameState.resources[resource] -= upgrade.cost[resource];
                    document.getElementById(resource).textContent = gameState.resources[resource];
                    document.getElementById(resource + '-input').value = gameState.resources[resource];
                }
                
                // Add upgrade
                gameState.upgrades[sectionId][pathType].push(upgradeIndex);
                
                // Update displays
                updateAllUpgradeStates();
                updatePowerLevel();
                saveGameState();
            }
        }

        function updateAllUpgradeStates() {
            Object.keys(sections).forEach(sectionId => {
                updateSectionProgress(sectionId);
                Object.keys(sections[sectionId].paths).forEach(pathType => {
                    sections[sectionId].paths[pathType].forEach((upgrade, index) => {
                        const upgradeElement = document.getElementById(`${sectionId}-${pathType}-${index}`);
                        if (upgradeElement) {
                            const isCompleted = gameState.upgrades[sectionId][pathType].includes(index);
                            const canAfford = canAffordUpgrade(upgrade.cost);
                            
                            const statusElement = upgradeElement.querySelector('.upgrade-status');
                            const buttonElement = upgradeElement.querySelector('.purchase-btn');
                            
                            if (isCompleted) {
                                statusElement.textContent = 'Completed';
                                statusElement.className = 'upgrade-status status-completed';
                                buttonElement.style.display = 'none';
                            } else if (canAfford) {
                                statusElement.textContent = 'Available';
                                statusElement.className = 'upgrade-status status-available';
                                buttonElement.disabled = false;
                                buttonElement.style.display = 'inline-block';
                            } else {
                                statusElement.textContent = 'Locked';
                                statusElement.className = 'upgrade-status status-locked';
                                buttonElement.disabled = true;
                                buttonElement.style.display = 'inline-block';
                            }
                        }
                    });
                });
            });
        }

        function updateSectionProgress(sectionId) {
            const total = Object.values(sections[sectionId].paths).reduce((sum, path) => sum + path.length, 0);
            const completed = Object.values(gameState.upgrades[sectionId]).reduce((sum, upgrades) => sum + upgrades.length, 0);
            const percentage = (completed / total) * 100;
            
            const progressFill = document.querySelector(`#${sectionId} .progress-fill`);
            const progressText = document.querySelector(`#${sectionId} .progress-text`);
            
            if (progressFill && progressText) {
                progressFill.style.width = percentage + '%';
                progressText.textContent = `${completed}/${total}`;
            }
        }

        function togglePath(sectionId, pathType) {
            const path = document.getElementById(`${sectionId}-${pathType}`);
            path.classList.toggle('expanded');
        }

        // Mission Management
        function createMission() {
            if (currentRole !== 'gm') return;
            
            const title = document.getElementById('missionTitle').value;
            const description = document.getElementById('missionDescription').value;
            const difficulty = document.getElementById('missionDifficulty').value;
            const rewardType = document.getElementById('rewardType').value;
            const rewardAmount = parseInt(document.getElementById('rewardAmount').value);
            const duration = parseInt(document.getElementById('missionDuration').value);
            
            // Get stat requirements
            const requirements = {
                skill: parseInt(document.getElementById('missionSkill').value) || 0,
                stealth: parseInt(document.getElementById('missionStealth').value) || 0,
                combat: parseInt(document.getElementById('missionCombat').value) || 0,
                tech: parseInt(document.getElementById('missionTech').value) || 0,
                social: parseInt(document.getElementById('missionSocial').value) || 0,
                will: parseInt(document.getElementById('missionWill').value) || 0
            };
            
            if (!title || !description) {
                alert('Please fill in all required fields');
                return;
            }
            
            const mission = {
                id: Date.now(),
                title,
                description,
                difficulty,
                requirements,
                reward: { type: rewardType, amount: rewardAmount },
                status: 'active',
                duration,
                assignedTo: null,
                assignedAt: null
            };
            
            gameState.missions.push(mission);
            renderMissions();
            renderPlayerMissions();
            
            // Clear form
            document.getElementById('missionTitle').value = '';
            document.getElementById('missionDescription').value = '';
            document.getElementById('rewardAmount').value = '10';
            document.getElementById('missionDuration').value = '24';
            
            // Reset stat requirements
            ['missionSkill', 'missionStealth', 'missionCombat', 'missionTech', 'missionSocial', 'missionWill'].forEach(id => {
                document.getElementById(id).value = '0';
            });
            
            saveGameState();
        }

        function renderMissions() {
            const container = document.getElementById('missionList');
            if (!container) return;
            container.innerHTML = '';
            
            gameState.missions.forEach(mission => {
                // Create stat requirements display
                const statReqs = [];
                if (mission.requirements) {
                    Object.entries(mission.requirements).forEach(([stat, value]) => {
                        if (value > 0) {
                            statReqs.push(`<span class="stat-requirement">${stat.charAt(0).toUpperCase() + stat.slice(1)}: ${value}</span>`);
                        }
                    });
                }
                
                // Calculate time remaining if assigned
                let timeInfo = '';
                if (mission.assignedTo && mission.assignedAt) {
                    const now = Date.now();
                    const endTime = mission.assignedAt + (mission.duration * 60 * 60 * 1000);
                    const remaining = endTime - now;
                    
                    if (remaining > 0) {
                        const hours = Math.floor(remaining / (60 * 60 * 1000));
                        const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                        timeInfo = `<div class="mission-timer">‚è±Ô∏è ${hours}h ${minutes}m remaining</div>`;
                    } else {
                        timeInfo = `<div class="mission-timer">‚úÖ Mission Complete - Awaiting GM Resolution</div>`;
                    }
                }
                
                const missionHtml = `
                    <div class="mission-item">
                        <div class="mission-actions">
                            <button class="action-btn" onclick="editMission(${mission.id})">Edit</button>
                            <button class="action-btn delete" onclick="deleteMission(${mission.id})">Delete</button>
                        </div>
                        <div class="mission-title">${mission.title}</div>
                        <div class="mission-description">${mission.description}</div>
                        ${statReqs.length > 0 ? `<div class="mission-stats">${statReqs.join('')}</div>` : ''}
                        <div class="mission-rewards">
                            <span>Difficulty: ${mission.difficulty}</span>
                            <span>Duration: ${mission.duration}h</span>
                            <span>Reward: ${resourceIcons[mission.reward.type]} ${mission.reward.amount}</span>
                            <span>Status: ${mission.status}</span>
                            ${mission.assignedTo ? `<span>Assigned to: ${mission.assignedTo}</span>` : ''}
                        </div>
                        ${timeInfo}
                    </div>
                `;
                container.innerHTML += missionHtml;
            });
        }

        function renderPlayerMissions() {
            const container = document.getElementById('playerMissionList');
            if (!container) return;
            container.innerHTML = '';
            
            const activeMissions = gameState.missions.filter(m => m.status === 'active');
            
            activeMissions.forEach(mission => {
                // Create stat requirements display
                const statReqs = [];
                if (mission.requirements) {
                    Object.entries(mission.requirements).forEach(([stat, value]) => {
                        if (value > 0) {
                            statReqs.push(`<span class="stat-requirement">${stat.charAt(0).toUpperCase() + stat.slice(1)}: ${value}</span>`);
                        }
                    });
                }
                
                // Check if mission is assigned and calculate time
                let timeInfo = '';
                let assignmentSection = '';
                
                if (mission.assignedTo && mission.assignedAt) {
                    const now = Date.now();
                    const endTime = mission.assignedAt + (mission.duration * 60 * 60 * 1000);
                    const remaining = endTime - now;
                    
                    if (remaining > 0) {
                        const hours = Math.floor(remaining / (60 * 60 * 1000));
                        const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                        timeInfo = `<div class="mission-timer">‚è±Ô∏è ${hours}h ${minutes}m remaining - Assigned to ${mission.assignedTo}</div>`;
                    } else {
                        timeInfo = `<div class="mission-timer">‚úÖ Mission Complete - Awaiting GM Resolution</div>`;
                    }
                } else {
                    // Show assignment options
                    assignmentSection = `
                        <div class="mission-assignment">
                            <h4 style="color: var(--gold); margin-bottom: 10px;">Assign Mission</h4>
                            <div class="assignment-options">
                                <button class="assign-btn" onclick="assignMission(${mission.id}, 'Jon')">
                                    <i class="fas fa-user"></i> Send Jon (RP)
                                </button>
                                <button class="assign-btn" onclick="showNPCSelector(${mission.id})">
                                    <i class="fas fa-users"></i> Send NPCs
                                </button>
                            </div>
                            <div id="npc-selector-${mission.id}" class="npc-selector" style="display: none;">
                                ${gameState.npcs.filter(npc => npc.status === 'available').map(npc => `
                                    <div class="npc-option" onclick="toggleNPCSelection(${mission.id}, ${npc.id})">
                                        <div style="font-weight: 600; margin-bottom: 5px;">${npc.name}</div>
                                        <div style="font-size: 0.8rem; display: flex; gap: 5px;">
                                            <span>S:${npc.stats.skill}</span>
                                            <span>St:${npc.stats.stealth}</span>
                                            <span>C:${npc.stats.combat}</span>
                                            <span>T:${npc.stats.tech}</span>
                                            <span>So:${npc.stats.social}</span>
                                            <span>W:${npc.stats.will}</span>
                                        </div>
                                    </div>
                                `).join('')}
                                <button class="assign-btn" onclick="assignSelectedNPCs(${mission.id})" style="grid-column: 1 / -1; margin-top: 10px;">
                                    Confirm Assignment
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                const missionHtml = `
                    <div class="mission-item">
                        <div class="mission-title">${mission.title}</div>
                        <div class="mission-description">${mission.description}</div>
                        ${statReqs.length > 0 ? `<div class="mission-stats">${statReqs.join('')}</div>` : ''}
                        <div class="mission-rewards">
                            <span>Difficulty: ${mission.difficulty}</span>
                            <span>Duration: ${mission.duration}h</span>
                            <span>Reward: ${resourceIcons[mission.reward.type]} ${mission.reward.amount}</span>
                        </div>
                        ${timeInfo}
                        ${assignmentSection}
                    </div>
                `;
                container.innerHTML += missionHtml;
            });
        }

        function assignMission(missionId, assignee) {
            const mission = gameState.missions.find(m => m.id === missionId);
            if (mission && !mission.assignedTo) {
                mission.assignedTo = assignee;
                mission.assignedAt = Date.now();
                mission.status = 'in-progress';
                
                renderMissions();
                renderPlayerMissions();
                saveGameState();
                
                if (assignee === 'Jon') {
                    alert('Mission assigned to Jon for RP! Notify your GM.');
                }
            }
        }

        function showNPCSelector(missionId) {
            const selector = document.getElementById(`npc-selector-${missionId}`);
            selector.style.display = selector.style.display === 'none' ? 'grid' : 'none';
        }

        const selectedNPCs = {};

        function toggleNPCSelection(missionId, npcId) {
            if (!selectedNPCs[missionId]) selectedNPCs[missionId] = [];
            
            const index = selectedNPCs[missionId].indexOf(npcId);
            const element = event.target.closest('.npc-option');
            
            if (index > -1) {
                selectedNPCs[missionId].splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedNPCs[missionId].push(npcId);
                element.classList.add('selected');
            }
        }

        function assignSelectedNPCs(missionId) {
            const selected = selectedNPCs[missionId];
            if (!selected || selected.length === 0) {
                alert('Please select at least one NPC');
                return;
            }
            
            const npcNames = selected.map(id => gameState.npcs.find(n => n.id === id)?.name).join(', ');
            assignMission(missionId, npcNames);
            
            // Reset selection
            selectedNPCs[missionId] = [];
        }

        function deleteMission(missionId) {
            if (currentRole !== 'gm') return;
            
            if (confirm('Are you sure you want to delete this mission?')) {
                gameState.missions = gameState.missions.filter(m => m.id !== missionId);
                renderMissions();
                saveGameState();
            }
        }

        function editMission(missionId) {
            if (currentRole !== 'gm') return;
            
            const mission = gameState.missions.find(m => m.id === missionId);
            if (mission) {
                document.getElementById('missionTitle').value = mission.title;
                document.getElementById('missionDescription').value = mission.description;
                document.getElementById('missionDifficulty').value = mission.difficulty;
                document.getElementById('rewardType').value = mission.reward.type;
                document.getElementById('rewardAmount').value = mission.reward.amount;
                document.getElementById('missionDuration').value = mission.duration || 24;
                
                // Set stat requirements
                if (mission.requirements) {
                    document.getElementById('missionSkill').value = mission.requirements.skill || 0;
                    document.getElementById('missionStealth').value = mission.requirements.stealth || 0;
                    document.getElementById('missionCombat').value = mission.requirements.combat || 0;
                    document.getElementById('missionTech').value = mission.requirements.tech || 0;
                    document.getElementById('missionSocial').value = mission.requirements.social || 0;
                    document.getElementById('missionWill').value = mission.requirements.will || 0;
                }
                
                deleteMission(missionId);
            }
        }

        // Section Management
        function startCleaning(sectionId) {
            const sectionState = gameState.sectionStates[sectionId];
            if (sectionState.status === 'damaged') {
                sectionState.status = 'cleaning';
                sectionState.cleanStart = Date.now();
                
                updateSectionDisplay(sectionId);
                saveGameState();
            }
        }

        function startRepair(sectionId) {
            const sectionState = gameState.sectionStates[sectionId];
            const costs = getSectionRepairCost(sectionId);
            
            // Check if player can afford repair
            if (canAffordRepair(costs)) {
                // Deduct costs
                Object.entries(costs).forEach(([resource, amount]) => {
                    gameState.resources[resource] -= amount;
                    document.getElementById(resource).textContent = gameState.resources[resource];
                    document.getElementById(resource + '-input').value = gameState.resources[resource];
                });
                
                sectionState.status = 'repairing';
                sectionState.repairStart = Date.now();
                
                updateSectionDisplay(sectionId);
                updateAllUpgradeStates();
                updatePowerLevel();
                saveGameState();
            } else {
                alert('Insufficient resources for repair!');
            }
        }

        function getSectionRepairCost(sectionId) {
            const costs = {
                luminarium: { 'celestial-silver': 20, 'runic-shards': 3, 'technical-expertise': 2 },
                sanctum: { 'celestial-silver': 15, 'divine-essence': 1 },
                wards: { 'celestial-silver': 25, 'runic-shards': 5, 'technical-expertise': 3 },
                throne: { 'celestial-silver': 18, 'runic-shards': 2, 'technical-expertise': 1 },
                gateway: { 'celestial-silver': 22, 'runic-shards': 4, 'divine-essence': 1 },
                fountain: { 'celestial-silver': 16, 'divine-essence': 2 }
            };
            return costs[sectionId] || {};
        }

        function canAffordRepair(costs) {
            return Object.entries(costs).every(([resource, amount]) => {
                return gameState.resources[resource] >= amount;
            });
        }

        function updateSectionDisplay(sectionId) {
            const sectionElement = document.getElementById(sectionId);
            if (!sectionElement) return;
            
            const sectionState = gameState.sectionStates[sectionId];
            const section = sections[sectionId];
            
            // Update status indicator
            const statusElement = sectionElement.querySelector('.section-status');
            if (statusElement) {
                statusElement.innerHTML = getSectionStatusHTML(sectionId);
            }
            
            // Update action buttons
            const actionsElement = sectionElement.querySelector('.section-actions');
            if (actionsElement) {
                actionsElement.innerHTML = getSectionActionsHTML(sectionId);
            }
            
            // Update power indicator
            const powerElement = sectionElement.querySelector('.power-indicator');
            if (powerElement) {
                powerElement.innerHTML = getPowerIndicatorHTML(sectionId);
            }
        }

        function getSectionStatusHTML(sectionId) {
            const sectionState = gameState.sectionStates[sectionId];
            const now = Date.now();
            
            let statusClass = 'status-' + sectionState.status;
            let statusText = sectionState.status.toUpperCase();
            let timerHTML = '';
            
            // Check if timers are complete
            if (sectionState.status === 'cleaning' && sectionState.cleanStart) {
                const elapsed = now - sectionState.cleanStart;
                const duration = 72 * 60 * 60 * 1000; // 72 hours in milliseconds
                
                if (elapsed >= duration) {
                    // Cleaning complete
                    sectionState.status = 'clean';
                    sectionState.cleanStart = null;
                    
                    // Grant cleaning rewards
                    grantCleaningRewards();
                    
                    statusClass = 'status-clean';
                    statusText = 'CLEAN';
                } else {
                    const remaining = duration - elapsed;
                    const hours = Math.floor(remaining / (60 * 60 * 1000));
                    const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                    timerHTML = `<div class="section-timer">‚è±Ô∏è Cleaning: ${hours}h ${minutes}m remaining</div>`;
                }
            }
            
            if (sectionState.status === 'repairing' && sectionState.repairStart) {
                const elapsed = now - sectionState.repairStart;
                const duration = 72 * 60 * 60 * 1000; // 72 hours in milliseconds
                
                if (elapsed >= duration) {
                    // Repair complete
                    sectionState.status = 'operational';
                    sectionState.repairStart = null;
                    
                    statusClass = 'status-operational';
                    statusText = 'OPERATIONAL';
                } else {
                    const remaining = duration - elapsed;
                    const hours = Math.floor(remaining / (60 * 60 * 1000));
                    const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
                    timerHTML = `<div class="section-timer">‚è±Ô∏è Repairing: ${hours}h ${minutes}m remaining</div>`;
                }
            }
            
            return `
                <span class="status-indicator ${statusClass}">${statusText}</span>
                ${timerHTML}
            `;
        }

        function getSectionActionsHTML(sectionId) {
            const sectionState = gameState.sectionStates[sectionId];
            const costs = getSectionRepairCost(sectionId);
            
            switch (sectionState.status) {
                case 'damaged':
                    return `<button class="section-btn" onclick="startCleaning('${sectionId}')">üßπ Clean Section</button>`;
                
                case 'clean':
                    const costDisplay = Object.entries(costs).map(([resource, amount]) => 
                        `${resourceIcons[resource]} ${amount}`
                    ).join(' ');
                    const canAfford = canAffordRepair(costs);
                    
                    return `
                        <button class="section-btn" onclick="startRepair('${sectionId}')" ${!canAfford ? 'disabled' : ''}>
                            üîß Repair Section
                        </button>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            Cost: ${costDisplay}
                        </div>
                    `;
                
                default:
                    return '';
            }
        }

        function getPowerIndicatorHTML(sectionId) {
            const sectionState = gameState.sectionStates[sectionId];
            
            if (sectionState.status === 'operational') {
                if (sectionId === 'luminarium') {
                    return `<div class="power-indicator power-generation">‚ö° +50 Power Generation</div>`;
                } else {
                    return `<div class="power-indicator power-draw">‚ö° -10 Power Draw</div>`;
                }
            }
            
            return '';
        }

        function grantCleaningRewards() {
            const rewardTypes = ['celestial-silver', 'runic-shards', 'divine-essence'];
            const randomType = rewardTypes[Math.floor(Math.random() * rewardTypes.length)];
            const amount = Math.floor(Math.random() * 3) + 1; // 1-3
            
            gameState.resources[randomType] += amount;
            document.getElementById(randomType).textContent = gameState.resources[randomType];
            document.getElementById(randomType + '-input').value = gameState.resources[randomType];
            
            alert(`Cleaning complete! Found ${amount} ${resourceIcons[randomType]} ${randomType.replace('-', ' ')}`);
            updateAllUpgradeStates();
            saveGameState();
        }

        // Timer Update System
        function updateTimers() {
            // Update section timers
            Object.keys(gameState.sectionStates).forEach(sectionId => {
                updateSectionDisplay(sectionId);
            });
            
            // Update mission timers
            renderMissions();
            renderPlayerMissions();
            
            // Update power level based on operational sections
            updatePowerLevel();
        }

        // Override power level calculation to include section power
        function updatePowerLevel() {
            let basePower = gameState.resources['celestial-power'];
            
            // Add/subtract power from operational sections
            Object.keys(gameState.sectionStates).forEach(sectionId => {
                const sectionState = gameState.sectionStates[sectionId];
                if (sectionState.status === 'operational') {
                    if (sectionId === 'luminarium') {
                        basePower += 50; // Luminarium generates power
                    } else {
                        basePower -= 10; // Other sections consume power
                    }
                }
            });
            
            const powerPercent = Math.min(100, Math.max(0, (basePower / 2000) * 100));
            const powerElement = document.getElementById('power-level');
            if (powerElement) {
                powerElement.textContent = Math.round(powerPercent) + '%';
                
                // Color coding based on power level
                if (powerPercent < 25) {
                    powerElement.style.color = 'var(--red)';
                } else if (powerPercent < 50) {
                    powerElement.style.color = 'var(--gold)';
                } else {
                    powerElement.style.color = 'var(--green)';
                }
            }
        }

        // NPC Management
        function createNPC() {
            if (currentRole !== 'gm') return;
            
            const name = document.getElementById('npcName').value;
            const description = document.getElementById('npcDescription').value;
            const image = document.getElementById('npcImage').value;
            
            const stats = {
                skill: parseInt(document.getElementById('npcSkill').value),
                stealth: parseInt(document.getElementById('npcStealth').value),
                combat: parseInt(document.getElementById('npcCombat').value),
                tech: parseInt(document.getElementById('npcTech').value),
                social: parseInt(document.getElementById('npcSocial').value),
                will: parseInt(document.getElementById('npcWill').value)
            };
            
            if (!name || !description) {
                alert('Please fill in name and description');
                return;
            }
            
            const npc = {
                id: Date.now(),
                name,
                description,
                image,
                stats,
                status: 'available'
            };
            
            gameState.npcs.push(npc);
            renderNPCs();
            
            // Clear form
            document.getElementById('npcName').value = '';
            document.getElementById('npcDescription').value = '';
            document.getElementById('npcImage').value = '';
            
            // Reset stats to 1
            ['npcSkill', 'npcStealth', 'npcCombat', 'npcTech', 'npcSocial', 'npcWill'].forEach(id => {
                document.getElementById(id).value = '1';
            });
            
            saveGameState();
        }

        function renderNPCs() {
            const container = document.getElementById('npcList');
            container.innerHTML = '';
            
            gameState.npcs.forEach(npc => {
                const npcHtml = `
                    <div class="npc-item">
                        <div class="npc-actions">
                            <button class="action-btn" onclick="editNPC(${npc.id})">Edit</button>
                            <button class="action-btn delete" onclick="deleteNPC(${npc.id})">Delete</button>
                        </div>
                        <div class="npc-avatar ${!npc.image ? 'no-image' : ''}">
                            ${npc.image ? `<img src="${npc.image}" alt="${npc.name}" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>'; this.parentElement.classList.add('no-image');">` : '<i class="fas fa-user"></i>'}
                        </div>
                        <div class="npc-info">
                            <div class="npc-name">${npc.name}</div>
                            <div class="npc-description">${npc.description}</div>
                            <div class="npc-stats">
                                <div class="npc-stat">
                                    <span class="npc-stat-label">Skill</span>
                                    <span class="npc-stat-value">${npc.stats.skill}</span>
                                </div>
                                <div class="npc-stat">
                                    <span class="npc-stat-label">Stealth</span>
                                    <span class="npc-stat-value">${npc.stats.stealth}</span>
                                </div>
                                <div class="npc-stat">
                                    <span class="npc-stat-label">Combat</span>
                                    <span class="npc-stat-value">${npc.stats.combat}</span>
                                </div>
                                <div class="npc-stat">
                                    <span class="npc-stat-label">Tech</span>
                                    <span class="npc-stat-value">${npc.stats.tech}</span>
                                </div>
                                <div class="npc-stat">
                                    <span class="npc-stat-label">Social</span>
                                    <span class="npc-stat-value">${npc.stats.social}</span>
                                </div>
                                <div class="npc-stat">
                                    <span class="npc-stat-label">Will</span>
                                    <span class="npc-stat-value">${npc.stats.will}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += npcHtml;
            });
        }

        function deleteNPC(npcId) {
            if (currentRole !== 'gm') return;
            
            if (confirm('Are you sure you want to delete this NPC?')) {
                gameState.npcs = gameState.npcs.filter(n => n.id !== npcId);
                renderNPCs();
                saveGameState();
            }
        }

        function editNPC(npcId) {
            if (currentRole !== 'gm') return;
            
            const npc = gameState.npcs.find(n => n.id === npcId);
            if (npc) {
                document.getElementById('npcName').value = npc.name;
                document.getElementById('npcDescription').value = npc.description;
                document.getElementById('npcImage').value = npc.image || '';
                
                // Set stats
                document.getElementById('npcSkill').value = npc.stats.skill;
                document.getElementById('npcStealth').value = npc.stats.stealth;
                document.getElementById('npcCombat').value = npc.stats.combat;
                document.getElementById('npcTech').value = npc.stats.tech;
                document.getElementById('npcSocial').value = npc.stats.social;
                document.getElementById('npcWill').value = npc.stats.will;
                
                deleteNPC(npcId);
            }
        }

        // GM Administrative Functions
        function addResources() {
            if (currentRole !== 'gm') return;
            
            const amount = prompt('Enter amount to add to all resources:', '100');
            if (amount) {
                const num = parseInt(amount);
                Object.keys(gameState.resources).forEach(resource => {
                    gameState.resources[resource] += num;
                    document.getElementById(resource).textContent = gameState.resources[resource];
                    document.getElementById(resource + '-input').value = gameState.resources[resource];
                });
                updateAllUpgradeStates();
                updatePowerLevel();
                saveGameState();
            }
        }

        function maxAllResources() {
            if (currentRole !== 'gm') return;
            
            Object.keys(gameState.resources).forEach(resource => {
                gameState.resources[resource] = 9999;
                document.getElementById(resource).textContent = gameState.resources[resource];
                document.getElementById(resource + '-input').value = gameState.resources[resource];
            });
            updateAllUpgradeStates();
            updatePowerLevel();
            saveGameState();
        }

        function zeroAllResources() {
            if (currentRole !== 'gm') return;
            
            if (confirm('Are you sure you want to reset all resources to zero?')) {
                Object.keys(gameState.resources).forEach(resource => {
                    gameState.resources[resource] = 0;
                    document.getElementById(resource).textContent = gameState.resources[resource];
                    document.getElementById(resource + '-input').value = gameState.resources[resource];
                });
                updateAllUpgradeStates();
                updatePowerLevel();
                saveGameState();
            }
        }

        function unlockAllUpgrades() {
            if (currentRole !== 'gm') return;
            
            if (confirm('Are you sure you want to unlock all upgrades?')) {
                Object.keys(sections).forEach(sectionId => {
                    Object.keys(sections[sectionId].paths).forEach(pathType => {
                        gameState.upgrades[sectionId][pathType] = sections[sectionId].paths[pathType].map((_, index) => index);
                    });
                });
                updateAllUpgradeStates();
                saveGameState();
            }
        }

        function resetAllUpgrades() {
            if (currentRole !== 'gm') return;
            
            if (confirm('Are you sure you want to reset all upgrades?')) {
                Object.keys(gameState.upgrades).forEach(sectionId => {
                    Object.keys(gameState.upgrades[sectionId]).forEach(pathType => {
                        gameState.upgrades[sectionId][pathType] = [];
                    });
                });
                updateAllUpgradeStates();
                saveGameState();
            }
        }

        function exportGameData() {
            if (currentRole !== 'gm') return;
            
            const data = JSON.stringify(gameState, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bastion-save.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function resetGame() {
            if (currentRole !== 'gm') return;
            
            if (confirm('Are you sure you want to reset the entire game? This cannot be undone!')) {
                localStorage.removeItem('bastion-game-state');
                location.reload();
            }
        }

        // Data Persistence
        function saveGameState() {
            localStorage.setItem('bastion-game-state', JSON.stringify(gameState));
        }

        function loadGameState() {
            const saved = localStorage.getItem('bastion-game-state');
            if (saved) {
                const savedState = JSON.parse(saved);
                Object.assign(gameState, savedState);
                
                // Ensure NPCs array exists for backwards compatibility
                if (!gameState.npcs) {
                    gameState.npcs = [
                        {
                            id: 1,
                            name: "Seraph Valdris",
                            description: "A former celestial scout with unmatched diplomatic skills and deep knowledge of divine protocols.",
                            image: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face",
                            stats: { skill: 6, stealth: 3, combat: 4, tech: 2, social: 8, will: 7 },
                            status: "available"
                        },
                        {
                            id: 2,
                            name: "Raven Blackthorne",
                            description: "Master infiltrator and information broker. Moves through shadows like they don't exist.",
                            image: "https://images.unsplash.com/photo-1494790108755-2616b612b786?w=150&h=150&fit=crop&crop=face",
                            stats: { skill: 5, stealth: 9, combat: 6, tech: 4, social: 3, will: 5 },
                            status: "available"
                        }
                    ];
                }
                
                // Ensure section states exist for backwards compatibility
                if (!gameState.sectionStates) {
                    gameState.sectionStates = {
                        luminarium: { status: 'damaged', cleanStart: null, repairStart: null },
                        sanctum: { status: 'damaged', cleanStart: null, repairStart: null },
                        wards: { status: 'damaged', cleanStart: null, repairStart: null },
                        throne: { status: 'damaged', cleanStart: null, repairStart: null },
                        gateway: { status: 'damaged', cleanStart: null, repairStart: null },
                        fountain: { status: 'damaged', cleanStart: null, repairStart: null }
                    };
                }
                
                // Update mission format for backwards compatibility
                gameState.missions.forEach(mission => {
                    if (!mission.requirements) {
                        mission.requirements = { skill: 0, stealth: 0, combat: 0, tech: 0, social: 0, will: 0 };
                    }
                    if (!mission.duration) {
                        mission.duration = 24;
                    }
                    if (!mission.assignedTo) {
                        mission.assignedTo = null;
                        mission.assignedAt = null;
                    }
                });
                
                // Update resource displays
                Object.keys(gameState.resources).forEach(resource => {
                    document.getElementById(resource).textContent = gameState.resources[resource];
                    document.getElementById(resource + '-input').value = gameState.resources[resource];
                });
            }
        }

        // Initialize Sections
        function initializeDashboard() {
            const container = document.getElementById('sections-container');
            container.innerHTML = '';
            
            Object.keys(sections).forEach(sectionId => {
                const section = sections[sectionId];
                const totalUpgrades = Object.values(section.paths).reduce((sum, path) => sum + path.length, 0);
                const completedUpgrades = Object.values(gameState.upgrades[sectionId]).reduce((sum, upgrades) => sum + upgrades.length, 0);
                const progressPercentage = (completedUpgrades / totalUpgrades) * 100;
                
                const sectionHtml = `
                    <div class="section-card" id="${sectionId}">
                        <div class="section-header">
                            <div class="section-title">${section.title}</div>
                            <div class="section-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                                </div>
                                <span class="progress-text">${completedUpgrades}/${totalUpgrades}</span>
                            </div>
                        </div>
                        
                        <!-- Section Status and Actions -->
                        <div class="section-status">
                            ${getSectionStatusHTML(sectionId)}
                        </div>
                        <div class="section-actions">
                            ${getSectionActionsHTML(sectionId)}
                        </div>
                        <div class="power-indicator">
                            ${getPowerIndicatorHTML(sectionId)}
                        </div>
                        
                        <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem;">${section.description}</p>
                        
                        <!-- Only show upgrades if section is operational -->
                        <div class="paths-container" ${gameState.sectionStates[sectionId].status !== 'operational' ? 'style="opacity: 0.5; pointer-events: none;"' : ''}>
                            ${Object.keys(section.paths).map(pathType => `
                                <div class="path ${pathType}" id="${sectionId}-${pathType}">
                                    <div class="path-header" onclick="togglePath('${sectionId}', '${pathType}')">
                                        <div class="path-name">
                                            <i class="fas fa-${pathType === 'research' ? 'microscope' : pathType === 'offensive' ? 'sword' : 'shield-alt'}"></i>
                                            ${pathType.charAt(0).toUpperCase() + pathType.slice(1)} Path
                                        </div>
                                        <span class="path-toggle">‚ñº</span>
                                    </div>
                                    <div class="upgrades-list">
                                        ${section.paths[pathType].map((upgrade, index) => `
                                            <div class="upgrade-item" id="${sectionId}-${pathType}-${index}">
                                                <div class="upgrade-header">
                                                    <div class="upgrade-name">${upgrade.name}</div>
                                                    <span class="upgrade-status status-locked">Locked</span>
                                                </div>
                                                <div class="upgrade-description">${upgrade.description}</div>
                                                <div class="upgrade-footer">
                                                    <div class="upgrade-cost">
                                                        ${Object.entries(upgrade.cost).map(([resource, amount]) => `
                                                            <span class="cost-item">
                                                                ${resourceIcons[resource]} ${amount}
                                                            </span>
                                                        `).join('')}
                                                    </div>
                                                    <button class="purchase-btn" onclick="purchaseUpgrade('${sectionId}', '${pathType}', ${index})" disabled>
                                                        Purchase
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += sectionHtml;
            });
            
            updateAllUpgradeStates();
            updatePowerLevel();
        }

        // Auto-save every 30 seconds
        setInterval(saveGameState, 30000);
    </script>
</body>
</html>
